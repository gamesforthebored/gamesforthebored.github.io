<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8"/>
<title>Tonality Composer (alpha version)</title>
<style>
* {
	font-family: "Lucida Console", Monaco, monospace;
}
#editor {
	border: 1px solid black;
	border-radius: 5px;
	padding: 2px;
	width: 796px;
	height: 300px;
}
#controls {
	width: 800px;
	height: 32px;
	font-size: 24px;
	margin-top: 5px;
	margin-bottom: 5px;
}
textarea, #highlights {
	width: 800px;
	height: 300px;
	margin: 0;
	border: 0;
	padding: 2px;
	font-size: 14pt;
	line-height: 18pt;
	background-color: transparent;
	border-radius: 0;
    white-space: pre-wrap;
    word-wrap: break-word;
    overflow: auto;
	position: absolute;
	resize: none;
	left: 11px;
}
#highlights {
	position: absolute;
	pointer-events: none;
	color: transparent;
}
#grid {
    width: 793px;
    margin-bottom: 8px;
    background-color: black;
    padding: 3px 3px 20px 6px;
    border-radius: 12px;
}
.row {
	margin-bottom: 2px;
}
.row:nth-child(even) {
	margin-left: 30.5px;
}
.clear {
	clear: both;
}
.cell {
	width: 58px;
	height: 33.49px; /* 58*sqrt(3)/3 */
	line-height: 33.49px;
	background-color: white;
	border-radius: 1px;
	font-size: 28px;
	text-align: center;
	margin-right: 3px;
	margin-bottom: 0px;
	margin-top: 16.74px; /* 58*sqrt(3)/6 */
	float: left;
	font-weight: bold;
}
.cell::before, .cell::after {
	content: "";
	width: 0;
	display: block;
	border-left: 29px solid transparent;
	border-right: 29px solid transparent;
}
.cell::before {
	border-bottom: 16.74px solid white;
	margin-top: -16.3px;
}
.cell::after {
	border-top: 16.74px solid white;
	margin-top: -0.5px;
}
.cell.active::before {
	border-bottom: 16.74px solid lime;
}
.cell.active::after {
	border-top: 16.74px solid lime;
}
#highlights .active, .cell.active {
	background-color: lime;
}
#highlights span {
	border-radius: 5px;
}
#highlights .erroneous {
	background-color: #f44;
}
#highlights .dissonant {
	background-color: #aaa;
}
#highlights .active.dissonant {
	background-color: #0a0;
}

#playButton, .blockedWhilePlaying {
	cursor: pointer;
}
#playControls.playing .blockedWhilePlaying {
	cursor: not-allowed;
}
#recordIndicator {
	width: 24px;
	text-align: center;
	color:red;
	display: inline-block;
}
#copiedTooltip {
	font-size: 14pt;
	position: absolute;
	margin-top: 1px;
	margin-left: -6px;
	padding: 2px;
	border-radius: 7px;
	background-color: black;
	color: white;
	cursor: default;
	text-wrap: nowrap;
	visibility: hidden;
	opacity: 0;
	transition: opacity 0.2s;
}
#copiedTooltip::before {
	content: "";
	border-width: 6px;
	border-style: solid;
	border-color: transparent;
	border-right: 6px solid black;
	display: inline-block;
	margin-top: 7px;
	margin-left: -13.5px;
	position: absolute;
}
#copiedTooltip.visible {
	visibility: visible;
	opacity: 1;
}
span.narrow {
	margin: -3px;
}
#waveforms span {
	cursor: pointer;
	padding: 5px;
	border-radius: 6px;
	padding-bottom: 0;
	font-weight: bold;
}
#waveforms span.selected {
	background-color: black;
	color: white;
}
</style>
</head>

<body onload="refreshHighlights()">

<div id="grid">
<div class="row">
	<div class="cell">G‚∏ó</div>
	<div class="cell">D‚∏ó</div>
	<div class="cell">A‚Åª</div>
	<div class="cell">E‚Åª</div>
	<div class="cell">B‚Åª</div>
	<div class="cell">F‚ôØ</div>
	<div class="cell">C‚ôØ</div>
	<div class="cell">G‚ôØ</div>
	<div class="cell">D‚ôØ</div>
	<div class="cell">A‚ôØ‚Å∫</div>
	<div class="cell">E‚ôØ‚Å∫</div>
	<div class="cell">B‚ôØ‚Å∫</div>
	<div class="cell">FùÑ™‚Ä°</div>
	<div class="clear"></div>
</div>
<div class="row">
	<div class="cell">B<span class="narrow">‚ô≠</span>‚∏ó</div>
	<div class="cell">F‚Åª</div>
	<div class="cell">C‚Åª</div>
	<div class="cell">G‚Åª</div>
	<div class="cell">D‚Åª</div>
	<div class="cell">A</div>
	<div class="cell">E</div>
	<div class="cell">B</div>
	<div class="cell">F‚ôØ‚Å∫</div>
	<div class="cell">C‚ôØ‚Å∫</div>
	<div class="cell">G‚ôØ‚Å∫</div>
	<div class="cell">D‚ôØ‚Å∫</div>
	<div class="clear"></div>
</div>
<div class="row">
	<div class="cell">G<span class="narrow">‚ô≠</span>‚∏ó</div>
	<div class="cell">D<span class="narrow">‚ô≠</span>‚∏ó</div>
	<div class="cell">A<span class="narrow">‚ô≠</span>‚Åª</div>
	<div class="cell">E<span class="narrow">‚ô≠</span>‚Åª</div>
	<div class="cell">B<span class="narrow">‚ô≠</span>‚Åª</div>
	<div class="cell">F</div>
	<div class="cell">C</div>
	<div class="cell">G</div>
	<div class="cell">D</div>
	<div class="cell">A‚Å∫</div>
	<div class="cell">E‚Å∫</div>
	<div class="cell">B‚Å∫</div>
	<div class="cell">F‚ôØ‚Ä°</div>
	<div class="clear"></div>
</div>
<div class="row">
	<div class="cell">BùÑ´‚∏ó</div>
	<div class="cell">F<span class="narrow">‚ô≠</span>‚Åª</div>
	<div class="cell">C<span class="narrow">‚ô≠</span>‚Åª</div>
	<div class="cell">G<span class="narrow">‚ô≠</span>‚Åª</div>
	<div class="cell">D<span class="narrow">‚ô≠</span>‚Åª</div>
	<div class="cell">A<span class="narrow">‚ô≠</span></div>
	<div class="cell">E<span class="narrow">‚ô≠</span></div>
	<div class="cell">B<span class="narrow">‚ô≠</span></div>
	<div class="cell">F‚Å∫</div>
	<div class="cell">C‚Å∫</div>
	<div class="cell">G‚Å∫</div>
	<div class="cell">D‚Å∫</div>
	<div class="clear"></div>
</div>
<div class="row">
	<div class="cell">GùÑ´‚∏ó</div>
	<div class="cell">DùÑ´‚∏ó</div>
	<div class="cell">AùÑ´‚Åª</div>
	<div class="cell">EùÑ´‚Åª</div>
	<div class="cell">BùÑ´‚Åª</div>
	<div class="cell">F<span class="narrow">‚ô≠</span></div>
	<div class="cell">C<span class="narrow">‚ô≠</span></div>
	<div class="cell">G<span class="narrow">‚ô≠</span></div>
	<div class="cell">D<span class="narrow">‚ô≠</span></div>
	<div class="cell">A<span class="narrow">‚ô≠</span>‚Å∫</div>
	<div class="cell">E<span class="narrow">‚ô≠</span>‚Å∫</div>
	<div class="cell">B<span class="narrow">‚ô≠</span>‚Å∫</div>
	<div class="cell">F‚Ä°</div>
	<div class="clear"></div>
</div>
</div>

<div id="controls">
	<div style="float:left" id="playControls">
		<span class="blockedWhilePlaying" onclick="shareLink()">#Ô∏è‚É£</span>
		<span id="copiedTooltip">Copied link</span>
		<select style="font-size: 20px" id="selector" onchange="setEditor(this)">
			<option value="welcome">Welcome</option>
			<option value="air">Air on the G String (Bach)</option>
			<option value="canon">Canon in D (Pachelbel)</option>
			<option value="sheba">Queen of Sheba (Handel)</option>
			<option value="taltal">Tal Tal Heights (Zelda)</option>
			<option value="">==========</option>
			<option value="part0">0. Reference manual</option>
			<option value="part1">1. Harmony</option>
			<option value="part2">2. Dissonance</option>
			<option value="part3">3. Pythagorean tuning</option>
			<option value="part4">4. The major scale</option>
			<option value="part5">5. The minor scale</option>
			<option value="part6">6. Coarse & fine accidentals</option>
			<option value="part7">7. Enharmonics</option>
		</select>
		<span onclick="skipToStart()" style="cursor: pointer">‚è™</span>
		<span onclick="playSong()" id="playButton">‚ñ∂Ô∏è</span>
		<span class="blockedWhilePlaying" onclick="startRecording()" id="recordButton">‚è∫</span>
		<span id="recordIndicator" style="display:none" title="Download audio file once playback stops">‚Ä¢</span>
	</div>
	<div style="float:right; text-align: right" id="waveforms">
		<span onclick="setWaveform(this)" id="w_sine">‚óØ</span>
		<span onclick="setWaveform(this)" id="w_triangle">‚ñ≥</span>
		<span onclick="setWaveform(this)" id="w_square">‚ñ¢</span>
		<span onclick="setWaveform(this)" id="w_pulse" style="font-weight:normal">‚¨®</span>
		<span onclick="setWaveform(this)" id="w_superpulse">‚úß</span>
		<span onclick="setWaveform(this)" id="w_sawtooth">‚òÜ</span>
	</div>
	<div class="clear"></div>
</div>
<div id="editor">
<div id="highlights"></div>
<textarea id="song" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" oninput="refreshHighlights()" onscroll="scrollEditor(this, event)">This won't work without Javascript!</textarea>
</div>

<!-- Hidden div for defining multi-line strings -->
<div style="display:none">

<div id="string_welcome">{Welcome to Tonality Composer!

Press Play ‚ñ∂Ô∏è to hear a C major scale:}

C D E F G A B C

{Tonality Composer is both an interactive introduction into music theory, and an open canvas for creating your own microtonal music. Go through the tutorial step-by-step, write your own tunes in this text box, or simply select one of the pre-written pieces above and watch the lights dance.}</div>
<div id="string_air">T(8=60) K(F#+A+C#+)
[ F'1~ | F8 B16 G F32~ E D16 Co D C+4 B+16~ A8. | A'2~ A16 F B#,~ B@ E~ D# A~ G | G2~ G16 E+ B~ A D~ C G~ F | F4. G#+16~ A D,8 D32 E F8 E16 E~ D
/ D'1~ | D4 B A2~ | A8 C@16 B C8 A'16 C, B8 R4. | B8 E16 D E F G E A,8 R4. | A2~ A8 G#16 A B8 G
/ A2 B | B,4 E E+2~ | E+8 Eb E~ E+ F R4. | E8 B4 E8 E+ R4. | D4. E+8 F D B Eo~
/ D,8 D' C C, B B' A A, | G G' G# G, A A' G@+ G, | F F' E+ E, D# D' B B' | E, E' D D, C C' A A' | D, D' C C, B B' G# E ]

|O|

[ C'16 B+ B32 C D8. C16 B A2
/ A'8 A4 G#+8 E+2
/ E+8 F B+ E C2
/ A8 D, E+ E, A16~ B+~ C~ D~ E+~ G+~ F~ E~ ]

|O|

[ F'1~ | F8 B16 G F32~ E D16 Co D C+4 B+16~ A8. | A'2~ A16 F B#,~ B@ E~ D# A~ G | G2~ G16 E+ B~ A D~ C G~ F | F4. G#+16~ A D,8 D32 E F8 E16 E~ D
/ D'1~ | D4 B A2~ | A8 C@16 B C8 A'16 C, B8 R4. | B8 E16 D E F G E A,8 R4. | A2~ A8 G#16 A B8 G
/ A2 B | B,4 E E+2~ | E+8 Eb E~ E+ F R4. | E8 B4 E8 E+ R4. | D4. E+8 F D B Eo~
/ D,8 D' C C, B B' A A, | G G' G# G, A A' G@+ G, | F F' E+ E, D# D' B B' | E, E' D D, C C' A A' | D, D' C C, B B' G# E ]

|O|

[ C'16 B B32 C D8. C16 B+ A2
/ A'8 A4 G#+8 E+2
/ E+8 F B, E C2
/ A8 D, E E+, A2 ]</div>

<div id="string_canon">T(4=40) K(F#+A+C#+E+) [
D4 A B F G D G A | D A B F G D G A | D A B F G D G A | D A B F G D G A | D A B F G D G A | D A B F G D G A | D A B F G D G A | D A B F G D G A | D A B F G D G A | D A B F G D G A | D A B F G D G A | D A B F G D G A | D A B F G D G A | D A B F G D G A | D A B F G D G A | D A B F G D G A | D A B F G D G A | D A B F G D G A | D A B F G D G A | D A B F G D G A | D A B F G D G A | D A B F G D G A | D A B F G D G A | D A B F G D G A | D A B F G D G A | D A B F G D G A | D A B F G D G A | D A B F G D G A | D1
/
R1 R1 | F'4 E D C B A B C | D C B A G F G E | D8 F A G F D F E D B D A' G B A G | F D E C' D F A A, B G A F D D' D. C16 | D C D D, C A' E F D D' C B C F A B G F Eo G F E D C B A G F E+ G F E | D E F G A E A G F B A G A G F E D B B' C D C B A G F Eo B' A B A G | F8 F' E4 R8 D F4 B A B C | D8 D, C4 R8 B D4 D. D8 D G E A | A16 F32 G A16 F32 G A A, B C D E F G F16 D32 Eo F16 F,32 G A B A G A F G A G16 B32 A G16 F32 E F E D E F G A B G16 B32 A B16 C32 D A B C D E+ F G A | F16 D32 E F16 E32 D E C D E F E D C D16 B32 C D16 D,32 Eo F G F E F D' C D B16 D32 C B16 A32 G A G F G A B C D B16 D32 C D16 C32 B C D E+ D C D B C | D8 R C R B R D R D, R D R D R E R | R A R A R F R A R G R F R G R E' | F16 F, G F E E' F E D F, D B' A A, G A B B' C B A A, G A B B' A B C C, B C | D D' E D C C, D C B B' A B C C, F E D D' Eo G F F, A F' D G F G E+ A, G A | F A A A A A A A F F F F F F A A G G G D' D D D D D D B B A A E' C | A F' F F E E E E D D D D A' A A A B B B B A A A A B B B B C C, C C | D D,32 E F16 D C C'32 D E16 C B B,32 C D16 B C A'32 G F16 E D G32 F Eo16 G F D32 E F16 A G B32 A G16 F E+ A32 G F16 E | F D'32 C D16 F, A A32 B C16 A F D'32 Eo F16 D F F32 E D16 C B B32 A B16 C D F32 E D16 F G D32 C B16 B A E+ A A | A4. A8 D,4. A'8 G4 A G8 D D. C16 | D8 D' C4 B A D,8. Eo16 F4 B E+,8. E16 | F8. F'16 F G F E D8. D16 D E D C B4 D D16 C@o B C A8. A16 | A8. A'16 A B A G F8. F16 F G F E D C@o B C A8. A16 G8 D' C#+. C16 | D8 D4 C B A G F8~ F. Eo16 E+4 | F8 F'4 E8 D D'4 C@8 B4 D8 A B4 A | A A,8. G16 F4 F'8. E16 D4. D8 D4 C | D8 D, C C' B B, A A' G G' F F, Eo B' E+, E' | F F, E E' D D, C C' B B' A A, G8. Eo'16 A,8 A | A1
/
R1 R1 | R1 R1 | F'4 E D C B A B C | D C B A G F G E | D8 F A G F D F E D B D A' G B A G | F D E C' D F A A, B G A F D D' D. C16 | D C D D, C A' E F D D' C B C F A B G F Eo G F E D C B A G F E+ G F E | D E F G A E A G F B A G A G F E D B B' C D C B A G F Eo B' A B A G | F8 F' E4 R8 D F4 B A B C | D8 D, C4 R8 B D4 D. D8 D G E A | A16 F32 G A16 F32 G A A, B C D E F G F16 D32 Eo F16 F,32 G A B A G A F G A G16 B32 A G16 F32 E F E D E F G A B G16 B32 A B16 C32 D A B C D E+ F G A | F16 D32 E F16 E32 D E C D E F E D C D16 B32 C D16 D,32 Eo F G F E F D' C D B16 D32 C B16 A32 G A G F G A B C D B16 D32 C D16 C32 B C D E+ D C D B C | D8 R C R B R D R D, R D R D R E R | R A R A R F R A R G R F R G R E' | F16 F, G F E E' F E D F, D B' A A, G A B B' C B A A, G A B B' A B C C, B C | D D' E D C C, D C B B' A B C C, F E D D' Eo G F F, A F' D G F G E+ A, G A | F A A A A A A A F F F F F F A A G G G D' D D D D D D B B A A E' C | A F' F F E E E E D D D D A' A A A B B B B A A A A B B B B C C, C C | D D,32 E F16 D C C'32 D E16 C B B,32 C D16 B C A'32 G F16 E D G32 F Eo16 G F D32 E F16 A G B32 A G16 F E+ A32 G F16 E | F D'32 C D16 F, A A32 B C16 A F D'32 Eo F16 D F F32 E D16 C B B32 A B16 C D F32 E D16 F G D32 C B16 B A E+ A A | A4. A8 D,4. A'8 G4 A G8 D D. C16 | D8 D' C4 B A D,8. Eo16 F4 B E+,8. E16 | F8. F'16 F G F E D8. D16 D E D C B4 D D16 C@o B C A8. A16 | A8. A'16 A B A G F8. F16 F G F E D C@o B C A8. A16 G8 D' C#+. C16 | D8 D4 C B A G F8~ F. Eo16 E+4 | F8 F'4 E8 D D'4 C@8 B4 D8 A B4 A | A A,8. G16 F4 F'8. E16 D4. D8 D4 C | D8 D, C C' B B, A A' G G' F F, Eo B' E+, E' | F1
/
R1 R1 | R1 R1 | R1 R1 | F'4 E D C B A B C | D C B A G F G E | D8 F A G F D F E D B D A' G B A G | F D E C' D F A A, B G A F D D' D. C16 | D C D D, C A' E F D D' C B C F A B G F Eo G F E D C B A G F E+ G F E | D E F G A E A G F B A G A G F E D B B' C D C B A G F Eo B' A B A G | F8 F' E4 R8 D F4 B A B C | D8 D, C4 R8 B D4 D. D8 D G E A | A16 F32 G A16 F32 G A A, B C D E F G F16 D32 Eo F16 F,32 G A B A G A F G A G16 B32 A G16 F32 E F E D E F G A B G16 B32 A B16 C32 D A B C D E+ F G A | F16 D32 E F16 E32 D E C D E F E D C D16 B32 C D16 D,32 Eo F G F E F D' C D B16 D32 C B16 A32 G A G F G A B C D B16 D32 C D16 C32 B C D E+ D C D B C | D8 R C R B R D R D, R D R D R E R | R A R A R F R A R G R F R G R E' | F16 F, G F E E' F E D F, D B' A A, G A B B' C B A A, G A B B' A B C C, B C | D D' E D C C, D C B B' A B C C, F E D D' Eo G F F, A F' D G F G E+ A, G A | F A A A A A A A F F F F F F A A G G G D' D D D D D D B B A A E' C | A F' F F E E E E D D D D A' A A A B B B B A A A A B B B B C C, C C | D D,32 E F16 D C C'32 D E16 C B B,32 C D16 B C A'32 G F16 E D G32 F Eo16 G F D32 E F16 A G B32 A G16 F E+ A32 G F16 E | F D'32 C D16 F, A A32 B C16 A F D'32 Eo F16 D F F32 E D16 C B B32 A B16 C D F32 E D16 F G D32 C B16 B A E+ A A | A4. A8 D,4. A'8 G4 A G8 D D. C16 | D8 D' C4 B A D,8. Eo16 F4 B E+,8. E16 | F8. F'16 F G F E D8. D16 D E D C B4 D D16 C@o B C A8. A16 | A8. A'16 A B A G F8. F16 F G F E D C@o B C A8. A16 G8 D' C#+. C16 | D8 D4 C B A G F8~ F. Eo16 E+4 | F8 F'4 E8 D D'4 C@8 B4 D8 A B4 A | A A,8. G16 F4 F'8. E16 D4. D8 D4 C | D1 ]</div>

<div id="string_sheba">T(4=120) K(BbEbF+A+C+)

[{Ob1} F'4. D16 F B4 D, | G F8. E+16 D4 R4 | D4. D16 F E@4. Co16 G' | A G F G Co,8 E@ F C+16 D C D C D | C4. A16 C F4. D16 F | E4. Co16 E D4 R4

/{Ob2} D'4. F16 D B4. F'16 D | Co8. B16 A8 A B4 R4 | B4. B16 D Co4. G'16 E@ | C B A B G8 Co A A16 B A B A B | A4. F16 A B4. F'16 B, | Co4. Ao16 C F,4 R4

/{Vln} B''16 F D F B F D F B F D F B F D F | Co B' Ao G F E+ D C+ D B C D Eo F G A | B F D F B F D F B E@, Co E B G C, G' | A G F G Co,8 E@ F F, R4 | C'16 A F A C A F A F' D B D F D B D | E Co Ao C E C A C D F, G A+ B C D E

/{Vla} D8 F F F D D D B' | B Co C+ F, F4 B, | F'8 F G G G G Co, C | C'16 B A B G8 Co, C+4 F8 C | C F F F B, B B B | G' Ao16 G A8 Fo F+4 D

/{Cel} B8 B A A G G F F | E E F F B4 B, | D8 D G G Co, C E@ E | F B Co C, F4 A,8 C+ | F F E+ E D D G G | Co, C Fo F B4 B,] O |

[{Ob1} F'8 D F D F C F C | D B D B D A D A | B' G B G B F B F | E16 Fo G F E D- Co B A B C+ B A G F+ E | D8 E F G A B C D | E16 F E F G Fo E D C D C D E+ F+ E F | G F G F E+ D E D C D C D E F E F | G F G F E+ D E D C D C D E D E C | D8 R2.. | R1

/{Ob2} D'8 B D B C A C A | B G B G A F A F | G' E G E F D F D | G,8 E'16 Fo G F E D C B A B C B A G | F8 E D G F B F B | Co16 D C D E D- C B A B A B C+ Do C D | E D E D C B C B A B A B C D C D | E D E D C B C B A B A B C B C A | B8 R2.. | R1

/{Vln} F'16 D B D F D B D F C A C F C A C | D B G B D B G B D A F A D A F A | B' G E G B G E G B F D F B F D F | E Fo G F E D- Co B A B C+ B A G F+ E | D F E G F A G B A C B D C E+ D F | [E F E F G Fo E D C D C D E+ F+ E F | G F G F E+ D E D C D C D E F E F | G F G F E+ D E D C D C D E D E C / Co D C D E D- C B A B A B C+ Do C D E D E D C B C B A B A B C D C D E D E D C B C B A B A B C B C A] | D F E G F A G B A8 G16 F B8 E, | D Co16 B F8 A B F B,4

/{Vla} B'8 F B F A F A F | G D G D F D F D | E B E B D B' D, B' | G E16 Fo G F E D C8 A'16 B C B A G | F8 Co16 E B8 B F' D F F | G G Co G C+, C A' A | A A A A A A A A | A A A A A A A A | F Ao B E, C' A+ F G | F G F E D4 R4

/{Cel} B8 B B B A A A A | G G G G F F F F | E E E E D D D D | Co C C E F F F A, | B Co D E F G A B | E, E E E F F F F | F F F F F F F F | F F F F F F F F | B, Co D E F E D E | F E F F, B4 R4]</div>

<div id="string_taltal">{From "The Legend of Zelda: Link's Awakening" (Kozue Ishikawa)}
T(4=150) K(Bb) O'16 [
D R D D D R D D D R D D D R D D |
E R E E E R E E E R E E E R E E |
F R F F F R F F F R F F F R F F |
E R E E E R E E E R E E E R E E /
G R G G G R G G G R G G G R G G |
G R G G G R G G G R G G G R G G |
G R G G G R G G G R G G G R G G |
G R G G G R G G G R G G G R G G ]

O'16 [G4 D. G8 G16 A B C | D1 | G4 D. G8 G16 A B C | D1 /
D R D D D R D D D R D D D R D D |
E R E E E R E E E R E E E R E E |
F R F F F R F F F R F F F R F F |
E R E E E R E E E R E E E R E E /
G R G G G R G G G R G G G R G G |
G R G G G R G G G R G G G R G G |
G R G G G R G G G R G G G R G G |
G R G G G R G G G R G G[G R G G / O,
                        D C B A ]]|
{-----}

{Melody} O'16 [
G8. D16 D4. G8 G16 A+ B C | D4. E16 F E8. D8. C8 | D8. G,16 G'2. | R4. D8 B' A B C | D G,16 D' G4 R8 D C B | C F,16 C' F4 R8 C B- A | B8. D,32. R64 D4. C24 D C B8 C | D1 | G,8. D16 D4. G8 G16 A+ B C | D4. Eb16 F E8. D. C | B. G16 D'4. B8 G' D | B'4. A+8 G A B C | D C16 D Eb4 R8 F. E. | D. A+. B C. B. A | G1 | G' /

{Harmony}
G, D' B D G, D' B D D, D' B D G, D' B D |
G, E' C E G, E' C E D, E' C E G, E' C E |
G, F' D F G, F' D F D, F' D F G, F' D F |
G, E' C E G, E' C E G, E' C E D, E' C E |
Eb D B D E D B D E D B D E D B D |
F C A C F C A C F C A C F C A C |
F+ D B D F D B D C Eb C E C E C E |
A+, F#+' D F A, F' D F A, F' D F A, F' D F |
G, D' B D G, D' B D G, D' B D G, D' B D |
Ab, Eb' C E A, E' C E A, E' C E A, E' C E |
G, D' B D G, D' B D G, D' B D G, D' B D |
E, D' B D E, D' B D E, D' B D E, D' B D |
Ab, Eb' C E A, E' C E A, E' C E A, E' C E |
D, G A+ C+ D8 R R2 | D'2 C | B C /

{Bass}
G,,8 R G R R4 G8 R | G R G R R4 G8 R |
G R G R R4 D'8 R | C R C R R4 C8 D |
Eb R E R R4 E8 R | F R F R R4 F8 R |
B, R B R C R C R | D R D R R4 D16 C B A+ |
G8 R G R R4 G8 R | Ab R A R R4 A8 R |
G R G R R4 F+8 R | E R E R R4 E8 R |
Ab R A R R4 A12 B C | D8 R R2 D,4 |
G8. D'. G, F. C'. F, | Eb. B'. E, F. C'. F, ]

{-----}

O'16
G, D' B D G, D' B D G, D' B D G, D' B D |
G, E' C E G, E' C E G, E' C E G, E' C E |
G, F' D F G, F' D F G, F' D F G, F' D F |
G, E' C E G, E' C E G, E' C E G, E' C E |
K(BbEbAbDb-GbCb)
A, E' C E A, E' C E A, E' C E A, E' C E |
A, F' D F A, F' D F A, F' D F A, F' D F |
A, G' E G A, G' E G A, G' E G A, G' E G |
A, F' D F A, F' D F A, F' D F A, F' D F |

{-----}

{Melody} O'16 [
A8. E16 E4. A8 A16 B C D | E4. F16 G F8. E8. D8 | E8. A,16 A'2. | R4. E8 C' B- C D | E A,16 E' A4 R8 E D C | Do G,16 D' G4 R8 D C B | C8. E,32. R64 E4. D24 E D C8 D | E1 | A,8. E16 E4. A8 A16 B C D | E4. Fb16 G F8. E. D | C. A16 E'4. C8 A' E | C'4. B8 A B C D | E D16 E Fb4 R8 G. F. | E. B. C D. C. B | A1 | A' /

{Harmony}
A, E' C E A, E' C E E, E' C E A, E' C E |
A, F' D F A, F' D F E, F' D F A, F' D F |
A, G' E G A, G' E G E, G' E G A, G' E G |
A, F' D F A, F' D F A, F' D F E, F' D F |
Fb E C E F E C E F E C E F E C E |
G Do B D G D B D G D B D G D B D |
G E C E G E C E D Fb D F D F D F |
B, G@' E G B, G' E G B, G' E G B, G' E G |
A, E' C E A, E' C E A, E' C E A, E' C E |
Bbb-, Fb' C F B, F' C F B, F' C F B, F' C F |
A, E' C E A, E' C E A, E' C E A, E' C E |
F@, E' C E F, E' C E F, E' C E F, E' C E |
Bbb-, Fb' C F B, F' C F B, F' C F B, F' C F |
E, A B D E8 R R2 | E'2 D | C D /

{Bass}
A,,8 R A R R4 A8 R | A R A R R4 A8 R |
A R A R R4 E'8 R | D R D R R4 D8 E |
Fb R F R R4 F8 R | G R G R R4 G8 R |
C, R C R D R D R | E R E R R4 E16 D C B |
A8 R A R R4 A8 R | Bbb- R B R R4 B8 R |
A R A R R4 G8 R | F@ R F R R4 F8 R |
Bbb- R B R R4 B12 C D | E8 R R2 E,4 |
A8. E'. A, G-. D'. G, | Fb. C'. F, G-. D'. G, ]</div>


<div id="string_part0">{Reference manual
=================

This page is a complete reference for all the features of Tonality Composer. You can skip this if you're going through the tutorials, since the tutorials introduce the features bit by bit. However, you can refer back to this page if you forget how something works, or read through it if you want to get started composing right away.

1. Playback
2. Rhythm
3. Octaves
4. Accidentals
5. The empty note "O"
6. Chords
7. Conclusion


1. Playback
-----------

Comments are enclosed in {curly brackets}. Everything inside curly brackets is ignored during playback. So, the first real notes in this section are the following, after the closing bracket:}

C E G C G E C

{Press Play (‚ñ∂Ô∏è) next to the menu to play the notes. If you put your cursor somewhere in this text editor, playback will begin at that point. Try it: Click somewhere in this paragraph, and press Play again.}

A C E A E C A

{This way, you can start playback in the middle of a piece. (Press ‚è™ to skip back to the start.)

The shape symbols on the right control which "instrument" will be used for playback: ‚óØ sine wave, ‚ñ≥ triangle wave, ‚ñ¢ square wave, ‚¨® pulse wave, ‚úß superpulse wave, or ‚òÜ sawtooth wave. (While a square wave is one that is "up" for ¬Ω of each cycle and "down" for ¬Ω, a pulse wave is up ¬º and down ¬æ, and a superpulse wave is an even harsher variant that is up ‚Öõ and down ‚Öû.)

You can also use a $ sign to force a particular instrument to be used, regardless of what is selected above.}

$s C D {"s" for Sine}
$t E F {"t" for Triangle}
$q G A {"q" for sQuare}
$p B C {"p" for Pulse}
$u G E {"u" for sUperpulse}
$w D C {"w" for saWtooth}
$ G A B C {plain "$" clears the forced instrument and returns to the default.


2. Rhythm
---------

You can vary the note length by putting a number after the note: "C1" is a whole-note C, "C2" is a half-note, "C4" is a quarter-note, etc. If the note length is omitted, the note is assumed to be of the same length as the previous note. (If it's the very first note, it's assumed to be a quarter note.)}

C4 C G' G A A G2 F4 F E E D D C2

{Add a "." after the note to lengthen it by a factor of ¬Ω (just like a dot in standard music notation). This does not carry forward to the following notes, but the underlying number does.}

G'4 G F F E8. D16 E8. F16 E4 D

{The tempo defaults to 80 quarter notes per minute. Change to a different tempo like this:}

T(4=100)

{This means that there should now be 100 quarter-notes (hence the "4") per minute. Something like "T(8=200)" would have the same effect (i.e. 200 eighth-notes per minute).}

C4 C G' G A A G2

{Use "R" to denote a rest. The rest will be the same length as a note in the same place would've been.}

F8 R F R E R E R D R D R C4 R2.

{You can also use "X" to make a white-noise sound, as a percussion accompaniment to your tune.}

X16 R X X X R X R X R X X X R X R R1 {


3. Octaves
----------

The distance between notes is assumed to be as short as possible. So, something like}

C4 F

{means a middle C followed by the F *above* it - since this is a jump of +5 semitones. It's not the F *below* middle C, because that would've been a jump of -7 semitones. What if the jump would be 6 semitones either way? E.g.:}

B F

{Here, we break the tie by preferring to go up rather than down. (This is even if the notes are modified with "+" or "-" - more on that later.)

Use "'" or "," to raise or lower a note by an octave. That's why we needed it for notating "Twinkle Twinkle Little Star" above:}

C,4 C G' G A A G2

{We don't need to mark the second G, since that G is already the closest note to itself. But if we hadn't included the mark, we would instead have}

C,4 C G G A A G2

{since the G *below* middle C is a shorter jump (-5 semitones) than the G *above* (+7 semitones) that we want.


4. Accidentals
--------------

Use "#" and "b" to denote sharps and flats. You can use "##" and "bb" for double sharps and flats, or even three or more (however, these notes will be too tonally distant to show up on the display above).}

C###'4 C## C# C@ Cb Cbb Cbbb R1

{The "@" is a "natural" sign, which cancels the effect of accidentals on the same note. If we didn't include it here, the plain "C" would have carried over the "#" accidental from the previous note. Another way to cancel accidentals is to include a barline "|", which undoes all accidentals on all notes. (This is the only purpose of barlines in Tonality Composer; there is no requirement that all "measures" have the same number of beats.)}

C#4 C C@ Cb | C R1

{You can also include a key signature to specify which accidentals should be assumed by default. Then the barlines will cancel the accidentals written on each note and restore the accidentals given in the key signature. For example, here's a melody in D major:}

K(F#C#) D4 D A' A B8 G# E G A2 | G4 G F F E8 C A C D2 | R1 K()

{Notice how the sharpness of the "G#" carries on to the following "G", but the barline cancels that out so the next G is natural. But whenever "F" and "C" appear, those are sharp, due to the key signature.

The "+" and "-" signs function similarly to sharps and flats. These raise or lower the pitch by a small amount (much less than a semitone), and are useful in building microtonal harmony, as explained in Part 3 of this tutorial.}

C+++'4 C++ C+ Co C- C-- C--- | R1

{Again, you can include any number of "+"s or "-"s (but some of these will be too distant to display on the grid). Notice that instead of a natural sign "@", we use the sign "o", which has the similar effect of canceling the previous pluses and minuses on that note.

These so-called "coarse" (# @ b) and "fine" (+ o -) accidentals can be combined to make more complex notes:}

C4 C+ C#+ C#o C@- Cb- Cbo | R1

{The most important thing to remember when combining accidentals like this is that *coarse accidentals carry over separately from fine accidentals*. For example, if the note "C" is given with no coarse accidentals (# @ b), it will sound with as many sharps/flats as the previous "C" in the measure (or key signature), and likewise for fine accidentals (+ o -); but marking coarse accidentals will not affect the fine accidentals on the following notes, nor vice-versa. Thus, the previous line could also be written like this, while sounding the same:}

C4 C+ C# Co C@- Cb Co | R1

{Both coarse and fine accidentals can be used in a key signature. In this way we can, for example, shift to the key of "E-plus major":}

K(F#++C#+G#+D#+A+E+B+)
E4 F G A B C D E | R2

{To return to the default key of C major, simply give an empty key signature:}

K()


{5. The empty note "O"
----------------------

"O" is not a real note. Rather, it's a device you can use to "reset" the octave and duration of the following notes. It's always possible to notate a melodic line without using "O", but it can sometimes simplify the notation a bit. Recall the line this reference manual begins with:}

C E G C G E C

{But it sounds different now, because the attributes of previous notes are being carried over. The notes are whole notes because the previous note was a whole rest; and the notes are in a high octave because that's what's closest to the previous note. But if we say "O" first, the octave returns to where it was at the beginning:}

O C E G C

{And we can also set the duration to something else,}

O8 C E G C

{or explicitly set the octave,}

O, C E G C

{or both:}

O''16 C E G C | R1 O {


6. Chords
---------

To play multiple notes at once, do something like this:}

C4 C G' G [A/F] [A/F] G2

{The simultaneous lines can last for any number of notes:}

O4 [F F E E D D / A A C C G G] C2

{Usually you'll want to make sure that each line is the same length - otherwise, the next note after the closing square bracket "]" will begin as soon as the *last written line* finishes - even if other lines still haven't finished yet.

Sometimes, after you press Play, certain notes will appear highlighted in gray:}

O1 [B / Gb]

{This indicates a dissonance (or more precisely a "wolf tone") i.e. a situation where the two notes sound "ugly" together, but one can be slightly adjusted to make it sound better. One of the challenges in writing microtonal music is to figure out how to tweak the notes to eliminate these.}

O1 [B / F#+]

{Or perhaps the dissonance is intentional!


7. Conclusion
-------------

That's it!}</div>

<div id="string_part1">{Harmony
========

Music is built from relations of numbers.}

C1 R

{This is Middle C, sounding at a frequency of 264 Hertz. (Press Play ‚ñ∂Ô∏è to hear the notes as we go, and Stop ‚èπ to keep reading. Place your cursor before each line of notes to start there.)

The most basic musical interval is the *octave*, which is a ratio of 2:1. The note one octave above Middle C, therefore, has a frequency of 528 Hz.}

C' R

{When played together, two notes an octave apart make a harmonious sound.}

O [C/C'] R

{Indeed, the two notes seem to mesh together so well that they almost sound like the same note. That's why they're all referred to by the same letter.}

O C,,8 C' C' C' C' C' R1 O

{(We use the , and ' marks to respectively lower and raise a note by one octave. These marks are relative to the previous note, so a series of C' notes will continue rising. The O symbol resets us to Middle C.)

But we can't build music out of octaves alone. We need other notes.

After the ratio 2:1, the next simplest ratio is (you guessed it) 3:1.}

C2 G'' O1 [C/G''] R O

{This new note is pretty high (786 Hz), so we can lower it by an octave to yield a note closer to the Middle C we started with. Now we have two notes with a ratio of 3:2.}

C2 G' O1 [C/G'] R O

{This interval of 3:2 is (somewhat confusingly, for reasons to be explained later) called a "fifth".

What if we instead go down by a fifth? This corresponds to a ratio of 2:3.}

C2 F, O1 [C/F,] R O

{But let's try to keep all of our notes within the same octave, i.e. between 264 Hz (1:1) and 528 Hz (2:1). This means we need to raise our new note by an octave, yielding a ratio of 4:3.}

C2 F O1 [C/F] R O

{This interval is called a "fourth". Putting this all together, and sorting the notes in ascending order, our fledgeling musical scale now has 3 distinct notes.}

C4 F G C O1 [C/F/G'/C'] R O

{Observe how these notes are depicted on the hexagonal grid above. Notes differing by octaves are all represented by the same letter and the same space on the grid, so factors of 2 are effectively ignored. But when you multiply by 3, you move one space to the right, and when you divide by 3, you move one space to the left.}

F4 C G' R1 O

{Now we're ready to go nuts - we can produce all notes in the scale by combining these two intervals, effectively forming a "ladder" across the grid, each step made up of a harmonious ratio of 3:2 or 4:3. Listen carefully to how the adjacent notes sound together; we'll slow down the tempo to 60 beats-per-minute to make the harmony easier to hear. It may also help if you select the Square instrument (‚ñ¢) or harsher (‚¨® ‚úß ‚òÜ) - the harsher the tone, the clearer the difference between harmony and dissonance.}

T(4=60) O1 [
C  D  E+  F#++ / R2 O1
 G' A+  B+     R2]

{Now, to the left:}

O1 [
C Bb-'   Ab-    Gb-- / R2 O1
 F    Eb-   Db--    R2 ] R1

{(What do all these +s and -s mean? More on that later.) So, by combining harmonious fifths and fourths, we've reached the "distant" note F#++ on the right, and Gb-- on the left. But aren't F-sharp and G-flat really the same note? What do they sound like together?}

[F#++ / Gb--]

{Yikes! What was that?

To be continued...}</div>

<div id="string_part2">{Part 2: Dissonance
===================

Let's look closely at what we just did with that "ladder" maneuver. Keep track of the ratios we used when moving rightward from C to F#++. When we go up by a fifth, it's a ratio of 3:2, and when we go down by a fourth, it's 3:4 (i.e. dividing by 4:3).}

C4 {3:2} G' {3:4} D {3:2} A+' {3:4} E+ {3:2} B+' {3:4} F#++ | R1 O

{When we combine these ratios, they multiply, so we find that the ratio from C to F#++ is 729:512.

Likewise, moving to the left, we have:}

C4 {4:3} F {4:3} Bb- {2:3} Eb-, {4:3} Ab- {2:3} Db--, {4:3} Gb-- | R1 O

{which shows that the ratio from C to Gb-- is 1024:512. These two ratios are close, but not quite equal:

F#++:C =  729:512 = 1.42383...
Gb--:C = 1024:729 = 1.40466...}

F#++ Gb-- | [F#++ / Gb--] | R

{Furthermore, although these two notes are close in pitch, they are very "distant" harmonically; that is, the ratio between them involves very large numbers. F#++:Gb-- = (729:512):(1024:729) = 531441:524288 = 1.01364... This is characteristic of a "wolf interval", so called because it sounds like a wolf howling. A wolf interval is produced when we have a ratio of large numbers which is very close in size to a ratio of much smaller numbers (in this case, 1:1).}</div>

<div id="string_part3">{Part 3: Pythagorean tuning
===========================

Notice something about the ratios we've discussed so far:

1:1
531441:524288
4:3
1024:729
729:512
2:1

All of these involve powers of 2 and 3:

1 : 1
3^12 : 2^19
2^2 : 3^1
2^10 : 3^6
3^6 : 2^9
2^1 : 1

This makes sense, since we formed all these ratios by combining the basic intervals of 3:2 and 4:3. Let's list all of the notes we've made in this way, this time from lowest to highest:}

C    { 1:1 } |
Db-- { 256:243  = 2^8  : 3^5 } |
D    { 9:8      = 3^2  : 2^3 } |
Eb-  { 32:27    = 2^5  : 3^3 } |
E+   { 81:64    = 3^4  : 2^6 } |
F    { 4:3      = 2^2  : 3^1 } |O8
Gb-- { 1024:729 = 2^10 : 3^6 } |
F#++ { 729:512  = 3^6  : 2^9 } |O'4
G    { 3:2      = 3^1  : 2^1 } |
Ab-  { 128:81   = 2^7  : 3^4 } |
A+   { 27:16    = 3^3  : 2^4 } |
Bb-  { 16:9     = 2^4  : 3^2 } |
B+   { 243:128  = 3^5  : 2^7 } |
C    { 2:1 } R1 O4

{We've made ourselves a scale! This is called the "Pythagorean tuning" after its supposed inventor; it's also called a "3-limit tuning" because 3 is the largest prime number that shows up in its ratios.

This scale contains all twelve notes we're accustomed to (or rather thirteen, since there are two options for the note in the middle - either 1024:729 or 729:512). However, it sounds somewhat strange to our ears because it contains a large number of dissonant intervals. To get a sense of how each ratio sounds, listen to the scale again, this time with a constant C under each note:}

T(4=40) [C C C C C C C C C C C C C /
C    { 1:1 } |
Db-- { 256:243  = 2^8  : 3^5 } |
D    { 9:8      = 3^2  : 2^3 } |
Eb-  { 32:27    = 2^5  : 3^3 } |
E+   { 81:64    = 3^4  : 2^6 } |
F    { 4:3      = 2^2  : 3^1 } |O8
Gb-- { 1024:729 = 2^10 : 3^6 } |
F#++ { 729:512  = 3^6  : 2^9 } |O'4
G    { 3:2      = 3^1  : 2^1 } |
Ab-  { 128:81   = 2^7  : 3^4 } |
A+   { 27:16    = 3^3  : 2^4 } |
Bb-  { 16:9     = 2^4  : 3^2 } |
B+   { 243:128  = 3^5  : 2^7 } |
C    { 2:1 } ] R1 O T(4=80)

{Again, the Pythagorean tuning is rather limiting by modern sensibilities, since it doesn't contain many options for harmonious chords. Besides the octave, we can have "power chords" containing a fourth or fifth:}

[C/F/C'] O [C/G/C'] O R

{And perhaps we might venture into "suspended chords" containing a 9:8 ratio:}

[C/F/G] O [C/D/G] O R

{But anything beyond that starts to get strange:}

[C/G/A+] O [C/E+/G] O R

{Indeed, for this reason, the ancient Pythagoreans would probably not have used "chords" in the modern sense. In order to produce our modern gamut of chords, we need to go beyond the number 3 - we need to introduce factors of 5.}</div>

<div id="string_part4">{Part 4: The major scale
========================

If the number 2 gives us octaves, and the number 3 gives us fifths, what does the number 5 give us?}

C2 E'' O1 [C/E''] O | C2 E O1 [C/E]

{As we did before with the 3:2 ratio, we first multiply the pitch by 5, and then reduce it by two octaves (i.e. divide by 4) to bring it down into the same range. This gives us a ratio of 5:4, which is called a "major third".

(In case you're wondering why the interval based on the number 3 is called a "fifth" and the one based on the number 5 is called a "third" - these names refer to the position in the scale, not the pitch ratio. So a "third" is formed with the root and the third note of the scale, and so on.)

The interval is called "major" because it's part of the *major triad*.}

C4 E G O1 [C/E/G]

{The major triad is a three-way ratio of 4:5:6, and will be a fundamental building-block of our new scale. It appears on the grid as an upward-pointing triangle (‚à¥).

But notice we've also implicitly created another interval - that between the E and the G, or a ratio of 6:5. Setting the root note back to C, we get the new note Eb. This is called a "minor third" and forms part of the *minor triad* - a somewhat more complex ratio of 10:12:15, which appears on the grid as a downward-pointing triangle (‚àµ).}

C4 Eb O2 [C/Eb] | C4 Eb G O1 [C/Eb/G] | O8

{Now you see why the hexagonal grid is set up the way it is. Just as factors of 3 are represented by moving left and right, factors of 5 are represented by moving along the "1 o'clock / 7 o'clock" axis.}

Bbb- Db- F A C# | Fb, Ab C E G# | Cb, Eb G B D# | R1 O8

{This, of course, means that the remaining direction (the "11 o'clock / 5 o'clock" axis) represents a combination of both 3 and 5, i.e. minor thirds.}

B- D- F Ab Cb | F# A C Eb Gb | C# E G Bb Db | O4

{Thus, any note involving the numbers 2, 3, and 5 is theoretically represented somewhere on the grid, although it may be too far from the center to show up in the display. For example, the note E# exists between and above C# and G#, and the three together form a major triad.}

C#4 E# G# O1 [C#/E#/G#] |

{But let's return to our C major triad:}

[C/E/G]

{If we're playing in the key of C major, our tune will revolve around this chord, and will generally start and end with it. But, of course, if we want our music to be interesting, we'll need more chords than just this. The most obvious choices to add next are the major triads rooted on the notes most closely related to C, namely G and F. If C is the "tonic", i.e. the root note of the overall scale, then G (the fifth above C) is called the "dominant", while F (the fifth below C) is called the "subdominant".}

G [G/B/D] F [F/A/C] O

{This may be starting to sound familiar. These three chords - the tonic, dominant, and subdominant major - are the most commonly-used chords in major-key music. Indeed, many simple tunes consist entirely of these chords.}

T(4=100)
[C'8. C16 | C4 G E'8. E16 | E4 C C8 E | G4. G8 F E | D2 D8. E16 | F4 F E8. D16 | E4 C C8 E | D4. G,8 B D | C2. /

R4 O2 | [C./E./G'.] | [C,./E./G.] | [C,./E./G.] | [G,./B./D.] | [F./A./C.] | [C./E./G.] | [G./B./D.] | [C./E./G.]] O4

{But notice also what we've achieved with these three chords - we've built the entire C major scale!}

C D E F G A B C

{This scale contains the three major triads, as we've seen; but as a byproduct of these, there are also two minor triads:}

O1 [A/C/E] [E/G/B]

{These chords can be used to add a hint of "sadness" to an otherwise major-key tune.}

T(4=80) O [
C2 G A E
F C F G /
E'8 G, C E D G, B D C E, A C B E, G B
A C, F A G C, E G A C, F A B D, G B ]</div>

<div id="string_part5">{Part 5: The minor scale
========================

We've already seen the C minor triad:}

O1 [C/Eb/G] R

{Now, we can apply the same method we used to create the major scale, this time to create an "inverted" analogue of it. In addition to this tonic minor triad, we also want to include the dominant and subdominant minor:}

[G/Bb/D] [F/Ab/C] R O4

{...and all these notes together form our C minor scale:}

C D Eb F G Ab Bb C R1 O

{And just as the major scale contains three major triads and two minor triads, the minor scale contains three minor and two major triads. These major triads can be used to add a hint of "happiness" to an otherwise minor-key tune. (Here we use a key signature "K(BbEbAb)" to avoid having to spell out the flats every time.)}

{"Arrival to Earth" from Transformers (2007) (Steve Jablonsky)}
K(BbEbAb) [
C'4. G16 C E4 B | D4. G,16 B C4 A | C4. G16 C G'4 E | F+ E8 D C4 A | C4. G16 C E4 B | D4. G,16 B C4 A | C2 B4 E8 D | C2. G8 B | C2 B4 D8 E | C1 /
O2 [C/E/G] [B/E/G] | [B/D/F+] [C/Fo/A] | [C/E/G] [B/E/G] | [B/D/F+] [C/Fo/A] | [C/E/G] [B/E/G] | [B/D/F+] [C/Fo/A] | O [C/E/A] [B/D/F+] | O1 [C/E/G] | O2 [C/E/A] [B/D/F+] | O1 [C/E/G] ]

{But this is somewhat more complex than the major-key tunes we've seen. That's because there's a stronger tendency to include major chords in a minor-key piece than the reverse. (Perhaps a long progression of minor chords sounds too depressing?) First, notice that the dominant chord [G/Bb/D] is actually not used at all - in fact, where a dominant does occur, it is very often the dominant *major*, as in the following excerpt from Beethoven's Fifth:}

O T(4=100) K(BbEbAbF+) [
G8. C16 | E4 E8. D16 C8. E16 | B@2
C8. D16 | E4 E8. D16 C8. E16 | F2
E8. F16 | G4 G8. F16 E8. G16 | F2
G8. F16 | E4 E8. D16 C8. E16 | D4. E8 C E | D2. /
R4 O, | [C C C / E E E / G' G G ] | [ G,2 G4 / D2 D4 / G2 G4 ]
   O, | [C C C / E E E / G' G G ] | [ B,2 B4 / D2 D4 / F2 F4 ]
      | [B, B B / E E E / G G G ] | [ B,2 B4 / D2 D4 / F2 F4 ]
   O, | [C C C / E E E / G' G G ] | [ G,2 G4 / D2 D4 / G2 G4 ]
      | [G,2. / D2. / G2.] ]

{Also notice that the exotic note F+ is often brought in in order to form the Bb major chord, which is technically not part of the C minor scale as we've defined it here, although this is not immediately obvious when playing a piano or reading standard music notation, where no distinction is made between F and F+.

What does all of this mean? To understand what's going on, we need to dive back into the math.}</div>

<div id="string_part6">{Part 6: Coarse & fine accidentals
==================================

We've defined several new notes in building our major and minor scales, but we haven't explicitly calculated their ratios yet. Let's see what we get.

* First, C (the tonic) is 1:1, by definition.
* Then, we have G = 3:2 (dominant) and F = 4:3 (subdominant), the same as in the Pythagorean system.
* The C major triad C:E:G is a ratio of 4:5:6, so E is 5:4.
* The dominant major triad G:B:D must therefore be (3:2):(15:8):(9:4), which gives us the value of B and D (and D can be reduced by one octave to 9:8).
* Similarly, the subdominant major triad F:A:C must be (4:3):(5:3):(2:1), which gives us the value of A.
* The C minor triad is 10:12:15, so Eb is 6:5.
* The dominant minor triad G:Bb:D must therefore be (3:2):(9:5):(9:4), which gives us the value of Bb.
* Finally, the subdominant minor triad F:Ab:C must be (4:3):(8:5):(2:1), which gives us the value of Ab.

In summary, we have the following notes:}

C  { 1:1 } |
{C#/Db???}
D  { 9:8 } |
Eb { 6:5 } |
E  { 5:4 } |
F  { 4:3 } |
{F#/Gb???}
G  { 3:2 } |
Ab { 8:5 } |
A  { 5:3 } |
Bb { 9:5 } |
B  { 15:8 } |
C  { 2:1 } R1 O4

{(Two notes are still missing because they're not present in any of the chords we've used so far. We'll get around to defining those later.)

As an aside - why do we notate these notes in this way? That is, why are we calling the notes used only in the minor scale "Eb, Ab, Bb" rather than "D#, G#, A#"? Ultimately it's a matter of convenience - we want each scale to use all seven letters exactly once, so that we can specify the accidentals in the key signature and not have to constantly switch between D@ (D natural) and D#, etc.

Now we can ask: What does the flat sign (b) mean?

As it so happens, a note with a flat sign is always at a ratio of 24:25 to the corresponding natural note. In other words, "b" lowers a note by 25:24; and therefore "#" raises a note by the same ratio. This interval of 25:24 is called a "chromatic semitone".

It's not a coincidence that every flat note is the same interval below its corresponding natural. In each case, we're changing a major triad to a minor triad, i.e. changing a major third (5:4) into a minor third (6:5), and (5:4):(6:5) = 25:24.

So, that's how we define the "b" and "#" signs. These are our "coarse accidentals", which are familiar from standard notation. But what about all those "+" and "-" signs?

Let's listen again to the Beethoven tune:}

O T(4=100) K(BbEbAb) [
G8. C16 | E4 E8. D16 C8. E16 | B@2
C8. D16 | E4 E8. D16 C8. E16 | F2 /
R4 O, | [C C C / E E E / G' G G ] | [ G,2 G4 / D2 D4 / G2 G4 ]
   O, | [C C C / E E E / G' G G ] | [ B,2 / D2 / F2 ] ] R1 O'

{Ouch!

You may have noticed that the F is no longer being given a "+" in the key signature, so we get this within the last chord:}

[Bb/F] R O'

{Using the ratios we found above, we can see that Bb:F is in the ratio (9:5):(4:3), or 27:20. Now 27/20 = 1.35, which is very close to the simpler ratio 4:3. It's another wolf interval! It's almost a perfect fourth, but it's slightly too large. For this reason, this interval is called an "acute fourth".

How much larger is it than a perfect fourth? The ratio is (27:20):(4:3), which works out to 81:80. Therefore, by raising the F by this ratio, we can restore the harmony:}

[Bb/F+] R O |

{This ratio of 81:80 is called the "syntonic comma", and is the last piece of the puzzle. We use the "+" symbol to raise a note by this interval, and "-" to lower it (a convention first developed by the composer Ben Johnston in the 1960s). These are our "fine accidentals".}

C- | C | C+

{(A "comma" is a small interval which is very close to 1:1. Incidentally, we've already seen a different comma before - namely the ratio 531441:524288 = (3^12 : 2^19), the so-called "Pythagorean comma".)

Starting from our base of seven natural notes (CDEFGAB), and combining the coarse and fine accidentals, we can form every note in the grid - that is, every ratio whose components can be factored into powers of 2, 3, and 5. This is the "5-limit tuning" system, also called "just intonation."}</div>

<div id="string_part7">{Part 7: Enharmonics
====================

Now we just need to wrap up a few loose ends.

How do we deal with those two missing notes in the scale? In the previous section, we weren't able to derive a value for the notes C#/Db and F#/Gb, because these notes don't occur in any of the basic chords we built our scale from. But now that we've precisely defined the "#" and "b" signs, it's clear what these notes must be:

C# = (1:1)*(25:24) = 25:24
Db = (9:8)/(25:24) = 27:25

F# = (4:3)*(25:24) = 25:18
Gb = (3:2)/(25:24) = 36:25

How do we decide which of the two options to use? It depends on the harmonic role that the note is serving.}

T(4=140) [
C'2 D24 E D E D E D E D C16 D | E4. F8 E4 D | C D E D8 C | D4 G, G G | C2 D24 E D E D E D E D C16 D | E4. F8 E4 D | C8 D C D D4. C8 | C1 | E2  F#24 G- F G F G F G F E16 F | G4. A+8 G4 F+ | E C C G | C G E C | E'2 F#24 G- F G F G F G F E16 F | G4. A+8 G4 F+ | E D8 C C D E F | D1 /
O1 [C/E/G] | [C/E/G] | [C/E/G] | [B/D/G] | [C/E/G] | [C/E/G] | [B/D/G]  | [C/E/G] | [D-/F#/A] | [B/D/G] | [C/E/G] | [C/E/G] | [D-/F#/A] | [B/D/G] | [C/E/G] | [B/D/G] ] R1

{Here, it's clear that the note we use has to be F#, because using Gb will either sound extremely dissonant or else force all the other notes to suddenly jump across the grid.

For a more complex demonstration of how "enharmonic equivalents" (i.e. notes that are written differently, but correspond to the same key on the piano) come into play, listen to the continuation of Jablonsky's "Transformers" soundtrack from before:}

T(4=80) K(BbEbAb) [
R4 C' G E' | F+ D B F' | R E B Gb' | A+ F+ Db A' | R Gb Db Bbb' | Cb A Fb C' | R A Fb Db-' | R Bbb- Fb Db-' | R A Fb Db-' | Cb1~ | Cb /
O1 [C/E/G'] | [B,/D/F+] | [B,/E/Gb] | [Db/F+/A+] | [Db,/Gb/Bbb] | [Fb/A/Cb] | [Fb,/A/Db-] | [Fb,/Bbb-/Db-] | [Fb,/A/Db-] | [Fb,~ E / Gb,~ G / Cb~ C] ] | R1

{There's a lot going on here, but it shows the flexibility of our microtonal notation system. Starting with C minor, this chord progression makes a wide excursion around the grid, making it necessary to use certain notes that you would normally never see, such as Bbb (which is off the grid, just below Gb and Db), Cb, and Fb (which are usually considered the same as A, B, and E respectively). Also, the progression abruptly jumps down by one syntonic comma in order to correct for the "comma pump" phenomenon that would otherwise cause it to end far from where it started. (Can you hear the moment where this happens?)

If we try writing the same tune "straightforwardly" using only single-flats and no fine accidentals, the need for all these variant notes becomes obvious:}

O K(BbEbAb) [
R4 C' G E' | F D B F' | R E B Gb' | A F Db A' | R Gb Db A@' | B@ A E@ B' | R A E@ Db' | R A@ E@ Db' | R A E@ Db' | B@1~ | B@ /
O1 [C/E/G'] | [B,/D/F] | [B,/E/Gb] | [Db/F/A] | [Db,/Gb/A@] | [E@/A/B@] | [E@,/A/Db] | [E@,/A@/Db] | [E@,/A/Db] | [E@,~ Eb / Gb,~ G / B@~ B] ]

{There are so many wolf intervals it's almost unrecognizable!}</div>

</div> <!-- End hidden div -->

<script>
// Constants:
const MIDDLE_C = 264;
const NOTE_BREAK = 0.1;
const NOISE_BREAK = 0.25;
const BREAK_MAX_MS = 100;
const FADEOUT_MS = 100;
const BASE_VOLUME = 0.02;
const RECORDING_GAIN = 3;
const INSTRUMENT_LETTERS = {
	s: "sine",
	t: "triangle",
	q: "square",
	p: "pulse",
	u: "superpulse",
	w: "sawtooth"
};
const VOLUME_ADJUSTMENT = {
	sine: 16/9,
	triangle: 4/3,
	square: 3/4,
	pulse: 1,
	superpulse: 4/3,
	sawtooth: 1
};
const NOTE_REGEX = "([ABCDEFGROX])([#b@+o-]*)([',]*)([0123456789]*)([.]*)(~?)";
const WHITE_NOTES = {C:0, D:2, E:4, F:5, G:7, A:9, B:11};
const JUST_INTONATION = {C:1, D:9/8, E:5/4, F:4/3, G:3/2, A:5/3, B:15/8};
const CHROMATIC_SEMITONE = 25/24;
const SYNTONIC_COMMA = 81/80;
const STANDALONE_CHARS = "[/]{}|";
const ELEMENTS = {
	highlights: document.getElementById("highlights"),
	song: document.getElementById("song"),
	waveforms: document.getElementById("waveforms"),
	selector: document.getElementById("selector"),
	playControls: document.getElementById("playControls"),
	playButton: document.getElementById("playButton"),
	recordButton: document.getElementById("recordButton"),
	recordIndicator: document.getElementById("recordIndicator"),
	copiedTooltip: document.getElementById("copiedTooltip")
};
// Global state representing the current playback:
const PLAYBACK_STATE = {
	playing: false, // Whether it is currently playing
	waveform: void(0), // Selected waveform, used if none is specified in the notation 
	recording: false, // Whether it is currently recording
	timeouts: [], // Currently active timeouts
	tones: {} // Currently sounding notes
};

// -----
// Highlighting:

function parseTextByTokens(text) {
	let output = "";
	let tokenIndex = 0;
	let spaceLast = !!text;
	for (let i=0; i<text.length; i++) {
		let c = text[i];
		if (STANDALONE_CHARS.includes(c)) {
			if (tokenIndex) {
				output += "</span>";
			}
			output += "<span id=\"ht_" + tokenIndex + "\">" + c + "</span>";
			tokenIndex++;
			spaceLast = true;
		} else if (c.match(/\s/)) {
			if (spaceLast) {
				output += c;
			} else {
				output += "</span>" + c;
			}
			spaceLast = true;	
		} else {
			if (spaceLast) {
				output += "<span id=\"ht_" + tokenIndex + "\">" + c;
				tokenIndex++;
				spaceLast = false;
			} else {
				output += c;
			}
		}
	}
	if (tokenIndex && !spaceLast) {
		output += "</span>";
	}
	return output;
}

function refreshHighlights() {
	if (PLAYBACK_STATE.playing) {
		stop();
	}
	ELEMENTS.highlights.innerHTML = parseTextByTokens(ELEMENTS.song.value);
}

function scrollEditor(element, event) {
	let position = event.target.scrollTop;
	ELEMENTS.highlights.scrollTo(0, position);
	if (position >= ELEMENTS.highlights.scrollTop) {
		element.scrollTo(0, ELEMENTS.highlights.scrollTop);
		event.preventDefault();
	}
}

function setHighlighting(tokenIndex, status) {
	let tokenSpan = document.getElementById("ht_" + tokenIndex);
	if (tokenSpan) {
		if (status === 3) {
			tokenSpan.classList.add("dissonant");
		} else if (status === 2) {
			tokenSpan.classList.add("erroneous");
		} else if (status === 1) {
			tokenSpan.classList.add("active");
		} else if (status === 0) {
			tokenSpan.classList.remove("active");
		}
	}
}

function displayErrors(compilationErrors) {
	for (let i=0; i<compilationErrors.length; i++) {
		setHighlighting(compilationErrors[i], 2);
	}
}

function displayDissonances(dissonances) {
	for (let i=0; i<dissonances.length; i++) {
		setHighlighting(dissonances[i], 3);
	}
}


// -----
// Grid display:

(function(){
	// Set IDs on cells in grid
	let cells = document.getElementsByClassName("cell");
	for (let i=0; i<cells.length; i++) {
		let cell = cells[i];
		let text = cell.innerText.toLowerCase();
		let id = "cell_" + text[0] + (
				text.includes("ùÑ™") ? "ss" :
				text.includes("‚ôØ") ? "s" :
				text.includes("‚ô≠") ? "f" :
				text.includes("ùÑ´") ? "ff" : ""
			) + (
				text.includes("‚Ä°") ? "pp" :
				text.includes("‚Å∫") ? "p" :
				text.includes("‚Åª") ? "m" :
				text.includes("‚∏ó") ? "mm" : ""
			);
		cell.id = id;
	}
})();

function activateCell(noteName) {
	let cell = document.getElementById("cell_" + noteName);
	if (cell) {
		cell.dataset.activation = 1+parseInt(cell.dataset.activation || "0");
		cell.classList.add("active");
	}
}

function deactivateCell(noteName) {
	let cell = document.getElementById("cell_" + noteName);
	if (cell) {
		cell.dataset.activation = parseInt(cell.dataset.activation) - 1;
		if (!parseInt(cell.dataset.activation)) {
			cell.classList.remove("active");
		}
	}
}


// -----
// Controls:

function setWaveform(element) {
	PLAYBACK_STATE.waveform = element.id.substring(2);
	let spans = ELEMENTS.waveforms.getElementsByTagName("span");
	for (let i=0; i<spans.length; i++) {
		let span = spans[i];
		if (span === element) {
			span.classList.add("selected");
		} else {
			span.classList.remove("selected");
		}
	}
}

setWaveform(document.getElementById("w_triangle"));

function skipToStart() {
	ELEMENTS.song.selectionStart = 0;
	ELEMENTS.song.selectionEnd = 0;
}

const SHARED_SONG_OPTION = "shared";
let sharedSongContent = "";
let sharedSongKey = "";

function setEditor(element, keepHash) {
	let value = element.value;
	if (value) {
		let string;
		if (value === SHARED_SONG_OPTION) {
			string = sharedSongContent;
			window.location.hash = sharedSongKey;
		} else {
			string = document.getElementById("string_" + value).innerText;
			if (!keepHash && window.location.hash && window.location.hash.length>1) {
				window.location.hash = "";
			}
		}
		ELEMENTS.song.value = string;
		refreshHighlights();
		if (PLAYBACK_STATE.playing) {
			stop();
		}
		skipToStart();
	}
}

setEditor(ELEMENTS.selector, true);


// -----
// Sounds:

function createPulseWaveform(audioContext, d, terms) {
	// https://en.wikipedia.org/wiki/Fourier_series#Table_of_common_Fourier_series
	let precision = 100000000;
	let real = new Float32Array(terms);
	let imag = new Float32Array(terms);
	real[0] = d;
	imag[0] = 0;
	for (let n=1; n<terms; n++) {
		real[n] = Math.round(precision*Math.sin(2*Math.PI*n*d)/(Math.PI*n))/precision;
		imag[n] = Math.round(precision*2*Math.pow(Math.sin(Math.PI*n*d),2)/(Math.PI*n))/precision;
	}
	return audioContext.createPeriodicWave(real, imag);
}

function createRecorder(stream) {
	if (!stream || !window.MediaRecorder) {
		ELEMENTS.recordButton.style.cursor = "not-allowed";
		ELEMENTS.recordButton.onclick = null;
		ELEMENTS.recordButton.title = "Your browser does not support audio recording.";
		return;
	}
	// https://developer.mozilla.org/en-US/docs/Web/API/AudioContext/createMediaStreamDestination
	let mediaRecorderChunks = [];
	let mediaRecorder = new MediaRecorder(stream);
	mediaRecorder.ondataavailable = (evt) => {
		mediaRecorderChunks.push(evt.data);
	};
	mediaRecorder.onstop = (evt) => {
		let blob = new Blob(mediaRecorderChunks, { type: "audio/ogg; codecs=vorbis" });
		let url = window.URL.createObjectURL(blob);
		let a = document.createElement("a");
		a.style = "display: none";
		a.href = url;
		a.download = "tune.ogg";
		document.body.appendChild(a);
		a.click();
		window.URL.revokeObjectURL(url);
		document.body.removeChild(a);
		mediaRecorderChunks = [];
	};
	return mediaRecorder;
}

const AUDIO = (function(){
	// http://stackoverflow.com/a/29641185
	let AudioContext = window.AudioContext || window.webkitAudioContext || window.audioContext;
	let audioCtx = AudioContext && new AudioContext;
	if (!audioCtx) {
		ELEMENTS.song.value = "Your browser doesn't support audio synthesis. Try one of the browsers listed here: https://caniuse.com/audio-api";
	}

	let recordingDestination = audioCtx.createMediaStreamDestination && audioCtx.createMediaStreamDestination();

	// Create buffer for white noise
	let bufferSize = 2 * audioCtx.sampleRate;
    let noiseBuffer = audioCtx.createBuffer(1, bufferSize, audioCtx.sampleRate);
    let output = noiseBuffer.getChannelData(0);
	for (let i = 0; i<bufferSize; i++) {
	    output[i] = Math.random() * 2 - 1;
	}

	return {
		context: audioCtx,
		pulseWaveform: audioCtx && createPulseWaveform(audioCtx, 0.25, 30),
		superpulseWaveform: audioCtx && createPulseWaveform(audioCtx, 0.125, 30),
		pulseWaveformInv: audioCtx && createPulseWaveform(audioCtx, 0.75, 30),
		superpulseWaveformInv: audioCtx && createPulseWaveform(audioCtx, 0.875, 30),
		recordingDestination: recordingDestination,
		recorder: createRecorder(recordingDestination && recordingDestination.stream),
		noiseBuffer: noiseBuffer
	};
})();

function tone(frequency, type) {
	if (!AUDIO.context) {
		return void(0);
	}
    let gainNode = AUDIO.context.createGain();
	let oscillator = AUDIO.context.createOscillator();
	oscillator.connect(gainNode);
    oscillator.frequency.value = frequency;
    if (type === "pulse") {
		oscillator.setPeriodicWave(Math.random()>0.5 ? AUDIO.pulseWaveform : AUDIO.pulseWaveformInv);
	} else if (type === "superpulse") {
		oscillator.setPeriodicWave(Math.random()>0.5 ? AUDIO.superpulseWaveform : AUDIO.superpulseWaveformInv);
    } else {
    	oscillator.type = type;
    }
	gainNode.connect(AUDIO.context.destination);
	if (PLAYBACK_STATE.recording) {
		let recordingGainNode = AUDIO.context.createGain();
		recordingGainNode.gain.value = RECORDING_GAIN;
		gainNode.connect(recordingGainNode);
		recordingGainNode.connect(AUDIO.recordingDestination);
	}
	let gainValue = BASE_VOLUME * VOLUME_ADJUSTMENT[type];
	gainNode.gain.value = gainValue;
	oscillator.start();
	return {
		stop: function(){
			// Fade out for a short time after the note "officially" ends, to soften the popping sound that would otherwise result from abruptly dropping to 0.
			let currentTime = AUDIO.context.currentTime;
			gainNode.gain.setValueAtTime(gainValue, currentTime);
			let stopTime = currentTime + FADEOUT_MS/1000;
			gainNode.gain.linearRampToValueAtTime(0, stopTime);
			oscillator.stop(stopTime);
		}
	}
}

function noiseTone() {
	let gainNode = AUDIO.context.createGain();
	let whiteNoise = AUDIO.context.createBufferSource();
	whiteNoise.buffer = AUDIO.noiseBuffer;
	whiteNoise.loop = true;
	whiteNoise.connect(gainNode);
	gainNode.connect(AUDIO.context.destination);
	if (PLAYBACK_STATE.recording) {
		let recordingGainNode = AUDIO.context.createGain();
		recordingGainNode.gain.value = RECORDING_GAIN;
		gainNode.connect(recordingGainNode);
		recordingGainNode.connect(AUDIO.recordingDestination);
	}
	gainNode.gain.value = 1/24;
	whiteNoise.start();
	return whiteNoise;
}


// -----
// Dissonance analysis:

function gcd(a,b) {
    if (a < 0) a = -a;
    if (b < 0) b = -b;
    if (b > a) {let temp = a; a = b; b = temp;}
    while (true) {
        if (b == 0) return a;
        a %= b;
        if (a == 0) return b;
        b %= a;
    }
}

function Rat(num,den) {
    this.num = num;
    this.den = den;
    return this;
}
const ONE_RAT = new Rat(1,1);
const TWO_RAT = new Rat(2,1);
Rat.prototype.plus = function(x) {
    let g = gcd(this.den, x.den);
    let newNum = this.num*x.den + x.num*this.den;
    let newDen = this.den*x.den;
    return new Rat(newNum/g, newDen/g);
}
Rat.prototype.times = function(x) {
    let newNum = this.num * x.num;
    let newDen = this.den * x.den;
    let g = gcd(newNum, newDen);
    return new Rat(newNum/g, newDen/g);
}
Rat.prototype.pow = function(power) {
	let result = ONE_RAT;
	let a = power > 0 ? this : this.inverse();
	for (let i=0; i<Math.abs(power); i++) {
		result = result.times(a);
	}
	return result;
}
Rat.prototype.negate = function() {
    return new Rat(-this.num, this.den);
}
Rat.prototype.inverse = function() {
    if (this.num === 0) {
        throw "Div0 error";
    }
    return new Rat(this.den, this.num);
}
Rat.prototype.toString = function() {
    return this.num + "/" + this.den;
}
Rat.prototype.toFloat = function() {
    return this.num/this.den;
}
Rat.prototype.copy = function() {
    return new Rat(this.num, this.den);
}
Rat.prototype.eq = function(x) {
	return x.num === this.num && x.den === this.den;
}
Rat.prototype.gt = function(x) {
	return this.num*x.den > x.num*this.den;
}
Rat.prototype.lt = function(x) {
	return this.num*x.den < x.num*this.den;
}

const JUST_INTONATION_RAT = {
    C: new Rat(1,1), D: new Rat(9,8), E: new Rat(5,4), F: new Rat(4,3),
    G: new Rat(3,2), A: new Rat(5,3), B: new Rat(15,8)
};
const CHROMATIC_SEMITONE_RAT = new Rat(25,24);
const SYNTONIC_COMMA_RAT = new Rat(81,80);

function ratForNote(noteName) {
	let base = JUST_INTONATION_RAT[noteName[0].toUpperCase()];
	let pluses = noteName.match(/p/g);
	pluses = pluses ? pluses.length : 0;
	let minuses = noteName.match(/m/g);
	minuses = minuses ? minuses.length : 0;
	let fineAccidentals = pluses - minuses

	let sharps = noteName.match(/s/g);
	sharps = sharps ? sharps.length : 0;
	let flats = noteName.substring(1).match(/f/g);
	flats = flats ? flats.length : 0;
	let coarseAccidentals = sharps - flats;

	let rat = base
		.times(CHROMATIC_SEMITONE_RAT.pow(coarseAccidentals))
		.times(SYNTONIC_COMMA_RAT.pow(fineAccidentals))
	return octaveReduce(rat);
}

function octaveReduce(rat) {
	while (rat.gt(TWO_RAT) || rat.eq(TWO_RAT)) {
		rat = rat.times(TWO_RAT.inverse())
	}
	while (rat.lt(ONE_RAT)) {
		rat = rat.times(TWO_RAT);
	}
	return rat;
}

function pitchClass(noteName) {
	let sharps = noteName.match(/s/g);
	sharps = sharps ? sharps.length : 0;
	let flats = noteName.substring(1).match(/f/g);
	flats = flats ? flats.length : 0;
	let coarseAccidentals = sharps - flats;
	let base = WHITE_NOTES[noteName[0].toUpperCase()];
	let result = base + coarseAccidentals;
	while (result < 0) {
		result += 12;
	}
	while (result >= 12) {
		result -= 12;
	}
	return result;
}

function findPitchClassNeighborhood(noteName) {
	let home = pitchClass(noteName);
	return [
		home,
		(home + 7) % 12,
		(home + 5) % 12,
		(home + 4) % 12,
		(home + 9) % 12,
		(home + 3) % 12,
		(home + 8) % 12
	];
}

function findRatNeighborhood(noteName) {
	let home = ratForNote(noteName);
	return [
		// must be in the same order:
		home,
		octaveReduce(home.times(new Rat(3,1))),
		octaveReduce(home.times(new Rat(1,3))),
		octaveReduce(home.times(new Rat(5,1))),
		octaveReduce(home.times(new Rat(5,3))),
		octaveReduce(home.times(new Rat(3,5))),
		octaveReduce(home.times(new Rat(1,5)))
	];
}

// Return a list of token indices where a simultaneous note is dissonant, i.e. where there is a note adjacent on the grid which is equivalent up to enharmonic spelling and fine accidentals.
function computeDissonances(compiled) {
	let dissonances = [];
	for (let i=0; i<compiled.length; i++) {
		let note = compiled[i];
		let startTime = note[0];
		let endTime = note[1];
		let noteName = note[3];
		let tokenIndex = note[4];
		if (noteName === "R" || noteName === "X") {
			continue;
		}
		let pcNeighborhood = findPitchClassNeighborhood(noteName);
		let ratNeighborhood = findRatNeighborhood(noteName);
		for (let j=0; j<compiled.length; j++) {
			if (j === i) {
				continue;
			}
			let otherNote = compiled[j];
			let otherStartTime = otherNote[0];
			let otherEndTime = otherNote[1];
			let otherNoteName = otherNote[3];
			if (otherStartTime >= endTime || otherEndTime <= startTime || otherNoteName === "R" || otherNoteName === "X") {
				continue;
			}
			let otherPitchClass = pitchClass(otherNoteName);
			let otherRat = ratForNote(otherNoteName);
			let pcMatch = pcNeighborhood.indexOf(otherPitchClass);
			if (pcMatch !== -1) {
				if (!otherRat.eq(ratNeighborhood[pcMatch])) {
					dissonances.push(tokenIndex);
				}
			}
		}
	}
	return dissonances;
}


// -----
// Parsing / compilation:

function parseOctaveMarkers(octaveMarkers) {
	let octaveUps = octaveMarkers.match(/'/g);
	octaveUps = octaveUps ? octaveUps.length : 0;
	let octaveDowns = octaveMarkers.match(/,/g);
	octaveDowns = octaveDowns ? octaveDowns.length : 0;
	let writtenOctaveAdjustment = octaveUps - octaveDowns;
	return writtenOctaveAdjustment;
}

function indexAwareSplit(string, regex) {
	let split = [];
	let indices = [];
	let matches = string.matchAll(regex);
	let match;
	let position = 0;
	while ((match = matches.next()) && !match.done) {
		split.push(string.substring(position, match.value.index));
		indices.push(position);
		position = match.value.index + match.value[0].length;
	}
	split.push(string.substring(position));
	indices.push(position);
	return {split:split, indices:indices};
}

function separateStandalones(tokensRaw, indicesRaw) {
	let tokens = [];
	let indices = [];
	for (let i=0; i<tokensRaw.length; i++) {
		let tokenRaw = tokensRaw[i];
		let indexRaw = indicesRaw[i];
		let resultingTokens = [];
		let string = "";
		let indicesWithinToken = [];
		let lastStart = 0;
		for (let j=0; j<tokenRaw.length; j++) {
			let c = tokenRaw[j];
			if (STANDALONE_CHARS.includes(c)) {
				resultingTokens.push(string);
				indicesWithinToken.push(lastStart);
				resultingTokens.push(c);
				indicesWithinToken.push(j);
				lastStart = j+1;
				string = "";
			} else {
				string += c;
			}
		}
		resultingTokens.push(string);
		indicesWithinToken.push(lastStart);
		for (let k=0; k<resultingTokens.length; k++) {
			let resultingToken = resultingTokens[k];
			if (resultingToken) {
				tokens.push(resultingToken);
				indices.push(indicesWithinToken[k] + indexRaw);
			}
			
		}
	}
	return {split:tokens, indices:indices};
}

function compileNotation(notation) {
	let splitAndIndicesRaw = indexAwareSplit(notation, /\s+/g);
	let tokensRaw = splitAndIndicesRaw.split;
	let tokenIndicesRaw = splitAndIndicesRaw.indices;
	if (tokensRaw && tokensRaw[0] === "") {
		tokensRaw = tokensRaw.slice(1);
		tokenIndicesRaw.slice(1);
	}
	let splitAndIndices = separateStandalones(tokensRaw, tokenIndicesRaw);
	let tokens = splitAndIndices.split;
	let indices = splitAndIndices.indices;
	let compiled = [];
	let invalidTokens = [];

	let wholeNotesPerMinute = 20; // default if no T() is specified
	let cursor = 0;
	let lastNoteLength = 4;
	let lastNoteValue = 0; // 0 = middle c, 1 = c#, etc
	let measureSignature = {};
	let forcedInstrument = "";

	let polyphonyStack = []; // contains arrays with the preceding 6 variables in that order
	let keySignature = {};
	let commentingLevel = 0;

	for (let i=0; i<tokens.length; i++) {
		let token = tokens[i];
		if (!token) {
			// Do nothing
		} else if (token === "}") {
			if (commentingLevel <= 0) {
				invalidTokens.push(i);
			} else {
				commentingLevel--;
			}
		} else if (token === "{") {
			commentingLevel++;
		} else if (commentingLevel) {
			// Do nothing
		} else if (token[0] === "T") {
			let inner = token.slice(2, -1);
			let parts = inner.split("=");
			if (!inner || parts.length !== 2) {
				invalidTokens.push(i);
				continue;
			}
			let beat = parts[0];
			let baseBeat = parseInt(beat);
			let dotCount = beat.endsWith(".") ? beat.match(/\./g).length : 0;
			let bpm = parseInt(parts[1]);
			if (isNaN(baseBeat) || isNaN(bpm)) {
				invalidTokens.push(i);
				continue;
			}
			wholeNotesPerMinute = bpm * (2 - Math.pow(2, -dotCount)) / baseBeat;
		} else if (token[0] === "K") {
			let inner = token.slice(2, -1);
			let noteInKS;
			let ksCoarse = 0;
			let ksFine = 0;
			keySignature = {};
			if (inner) {
				for (let k=0; k<inner.length; k++) {
					let c = inner[k];
					if ("ABCDEFG".includes(c)) {
						keySignature[noteInKS] = [ksCoarse, ksFine];
						ksCoarse = 0;
						ksFine = 0;
						noteInKS = c;
					} else {
						if (c === "#") {
							ksCoarse++;
						} else if (c === "b") {
							ksCoarse--;
						} else if (c === "+") {
							ksFine++;
						} else if (c === "-") {
							ksFine--;
						}
					}
				}
				keySignature[noteInKS] = [ksCoarse, ksFine];
			}
		} else if (token[0] === "$") {
			if (token.length > 1) {
				if (token.length === 2 && INSTRUMENT_LETTERS[token[1]]) {
					forcedInstrument = token[1];
				} else {
					invalidTokens.push(i);
					continue;
				}
			} else {
				forcedInstrument = "";
			}
		} else if (token === "|") {
			measureSignature = {};
		} else if (token === "[") {
			polyphonyStack.push([wholeNotesPerMinute, cursor, lastNoteLength, lastNoteValue, JSON.stringify(measureSignature), forcedInstrument]);
		} else if (token === "/") {
			if (!polyphonyStack.length) {
				invalidTokens.push(i);
				continue;
			}
			// Return to the state as of the start of the polyphony
			let topOfStack = polyphonyStack[polyphonyStack.length-1];
			wholeNotesPerMinute = topOfStack[0];
			cursor = topOfStack[1];
			lastNoteLength = topOfStack[2];
			lastNoteValue = topOfStack[3];
			measureSignature = JSON.parse(topOfStack[4]);
			forcedInstrument = topOfStack[5];
		} else if (token === "]") {
			if (polyphonyStack.length < 1) {
				invalidTokens.push(i);
				continue;
			}
			polyphonyStack.pop();
			// All values are now as of the last line of the polyphony, even if the lines were not the same length, which means that the next note may start while some of the lines are still playing.
		} else {
			let parsedNote = token.match(NOTE_REGEX);
			if (!parsedNote || parsedNote.length !== 7 || parsedNote.slice(1).join("") !== token) {
				invalidTokens.push(i);
				continue;
			}
			let noteLetter = parsedNote[1];
			let accidentals = parsedNote[2] || "";
			let octaveMarkers = parsedNote[3] || "";
			let noteLength = parsedNote[4] || "";
			let dots = parsedNote[5] || "";
			let slur = parsedNote[6] || "";

			if (noteLength && noteLength[0] === "0") {
				invalidTokens.push(i);
				continue;
			}
			if (noteLength) {
				lastNoteLength = parseInt(noteLength);
			}

			let noteLengthMinutes = 1/(wholeNotesPerMinute*lastNoteLength);
			let noteLengthMs = noteLengthMinutes * 60000;
			noteLengthMs *= (2 - Math.pow(2, -dots.length));
			let breakFactor =
				slur || noteLetter === "R" ? 0 :
				noteLetter === "X" ? NOISE_BREAK :
				NOTE_BREAK;
			let breakLength = Math.min(BREAK_MAX_MS, noteLengthMs * breakFactor);
			let startTime = cursor;
			let endTime = cursor + (noteLengthMs - breakLength);

			if (noteLetter !== "O") {
				cursor += noteLengthMs;
			}

			if (noteLetter === "O") {
				let writtenOctaveAdjustment = parseOctaveMarkers(octaveMarkers);
				lastNoteValue = 12*writtenOctaveAdjustment;
			} else if (noteLetter === "R" || noteLetter === "X") {
				compiled.push([startTime, endTime, 0, noteLetter, i, indices[i], indices[i]+token.length, ""]);
			} else {
				let ksAccidentals = keySignature[noteLetter];
				let coarseAccidentals = 0;
				if (accidentals.includes("#") || accidentals.includes("b") || accidentals.includes("@")) {
					let sharps = accidentals.match(/#/g);
					sharps = sharps ? sharps.length : 0;
					let flats = accidentals.match(/b/g);
					flats = flats ? flats.length : 0;
					coarseAccidentals = sharps - flats;
					if (!measureSignature[noteLetter]) {
						measureSignature[noteLetter] = [coarseAccidentals, null];
					} else {
						measureSignature[noteLetter][0] = coarseAccidentals;
					}
				} else if (measureSignature[noteLetter] && measureSignature[noteLetter][0] !== null) {
					coarseAccidentals = measureSignature[noteLetter][0];
				} else if (ksAccidentals) {
					coarseAccidentals = ksAccidentals[0];
				}

				let fineAccidentals = 0;
				if (accidentals.includes("+") || accidentals.includes("-") || accidentals.includes("o")) {
					let pluses = accidentals.match(/\+/g);
					pluses = pluses ? pluses.length : 0;
					let minuses = accidentals.match(/-/g);
					minuses = minuses ? minuses.length : 0;
					fineAccidentals = pluses - minuses;
					if (!measureSignature[noteLetter]) {
						measureSignature[noteLetter] = [null, fineAccidentals];
					} else {
						measureSignature[noteLetter][1] = fineAccidentals;
					}
				} else if (measureSignature[noteLetter] && measureSignature[noteLetter][1] !== null) {
					fineAccidentals = measureSignature[noteLetter][1];
				} else if (ksAccidentals) {
					fineAccidentals = ksAccidentals[1];
				}

				let naiveValue = WHITE_NOTES[noteLetter] + coarseAccidentals;
				let bounds = findBounds(lastNoteValue, naiveValue);
				let upperBound = bounds[1];
				let lowerBound = bounds[0];
				let lowerDiff = lastNoteValue - lowerBound;
				let upperDiff = upperBound - lastNoteValue;
				let adjustedValue = upperDiff<=lowerDiff ? upperBound : lowerBound;

				let writtenOctaveAdjustment = parseOctaveMarkers(octaveMarkers);
				adjustedValue += (12 * writtenOctaveAdjustment);
				lastNoteValue = adjustedValue;
				let octaveAdjustment = (adjustedValue - naiveValue)/12;

				let pitch = MIDDLE_C *
					Math.pow(2, octaveAdjustment) *
					JUST_INTONATION[noteLetter] *
					Math.pow(CHROMATIC_SEMITONE, coarseAccidentals) *
					Math.pow(SYNTONIC_COMMA, fineAccidentals);
				let noteName = noteLetter.toLowerCase() + 
					(coarseAccidentals ? new Array(1+Math.abs(coarseAccidentals)).join(coarseAccidentals>0 ? "s" : "f") : "") +
					(fineAccidentals ? new Array(1+Math.abs(fineAccidentals)).join(fineAccidentals>0 ? "p" : "m") : "");
				compiled.push([startTime, endTime, pitch, noteName, i, indices[i], indices[i]+token.length, forcedInstrument]);
			}
		}
	}
	return [compiled, invalidTokens];
}


// -----
// Playback:

function findBounds(anchor, floating) {
	let lower = -Infinity;
	let upper = Infinity;
	for (let v=anchor-12; v<=anchor+12; v++) {
		if ((v - floating) % 12 === 0) {
			if (v <= anchor) {
				lower = v;
			}
			if (v >= anchor) {
				upper = v;
				break;
			}
		}
	}
	return [lower, upper];
}

function chooseWaveform(instrumentLetter) {
	return !instrumentLetter ? PLAYBACK_STATE.waveform : INSTRUMENT_LETTERS[instrumentLetter];
}

// `compiled` is an array of notes given as 8-element arrays [0:startTime, 1:endTime, 2:frequency, 3:noteName, 4:tokenIndex, 5:notationStart, 6:notationEnd, 7:forcedInstrument]
// (Times are given in milliseconds)
// tokenIndex = the sequence order of the token representing this note (0 for first, etc.)
// notationStart, notationEnd = the character position where the token begins and ends
function play(compiled, cursorPosition) {
	// Find the first token that ends after the cursorPosition. Start playback at the startTime of that note. If there is no such note, start from 0.
	let cursorNote = false;
	let nextAfterCursor = Infinity;
	for (let i=0; i<compiled.length; i++) {
		let note = compiled[i];
		let notationStart = note[5];
		let notationEnd = note[6];
		if (notationEnd > cursorPosition) {
			if (notationStart < nextAfterCursor) {
				nextAfterCursor = notationStart;
				cursorNote = note;
			}
		}
	}
	let playbackStartTime = cursorNote ? cursorNote[0] : 0;
	let lastEndTime = 0;
	if (PLAYBACK_STATE.recording) {
		AUDIO.recorder.start();
	}
	let tiedGroup = [];
	for (let i=0; i<compiled.length; i++) {
		let note = compiled[i];
		let startTime = note[0];
		let endTime = note[1];
		lastEndTime = Math.max(endTime, lastEndTime);
		let frequency = note[2];
		let noteName = note[3];
		let tokenIndex = note[4];
		let forcedInstrument = note[7];
		let duration = endTime - startTime;
		if (startTime < playbackStartTime) {
			continue;
		}

		let nextNote = i+1<compiled.length ? compiled[i+1] : null;
		let tiedToNext =
			nextNote &&
			endTime === nextNote[0] && // start time of next note
			frequency === nextNote[2] &&
			noteName === nextNote[3] &&
			(forcedInstrument || "") === (nextNote[7] || "");
		// If the current note is part of a tie, its timeout should do highlighting but no sound.
		let isInTie = tiedToNext || tiedGroup.length;

		PLAYBACK_STATE.timeouts.push(createNoteTimeout(startTime-playbackStartTime, frequency, duration, noteName, tokenIndex, forcedInstrument, !isInTie, true));

		if (!tiedToNext && tiedGroup.length) {
			// But if the current note is the last in the tied group, also set a timeout that does sound (for the entire duration of the tie) but no highlighting.
			let startTimeOfGroup = tiedGroup[0][0];
			let durationOfGroup = endTime - startTimeOfGroup;
			tiedGroup = [];
			PLAYBACK_STATE.timeouts.push(createNoteTimeout(startTimeOfGroup-playbackStartTime, frequency, durationOfGroup, noteName, tokenIndex, forcedInstrument, true, false));
		}
		if (tiedToNext) {
			tiedGroup.push(note);
		}
	}
	PLAYBACK_STATE.timeouts.push(setTimeout(function(){
		ELEMENTS.playButton.innerText = "‚ñ∂Ô∏è";
		PLAYBACK_STATE.playing = false;
		ELEMENTS.playControls.classList.remove("playing");
		if (PLAYBACK_STATE.recording) {
			stopRecording();
		}
	}, lastEndTime-playbackStartTime));
}

function createNoteTimeout(timeoutStartFromNow, frequency, duration, noteName, tokenIndex, forcedInstrument, doSound, doHighlights) {
	return setTimeout(function(){
		if (doHighlights) {
			activateCell(noteName);
			setHighlighting(tokenIndex, 1);
		}
		let oscillator =
			!doSound || noteName === "R" ? null :
			noteName === "X" ? noiseTone() :
			tone(frequency, chooseWaveform(forcedInstrument));
		if (oscillator) {
			PLAYBACK_STATE.tones[tokenIndex] = oscillator;
		}
		PLAYBACK_STATE.timeouts.push(setTimeout(function(){
			if (doHighlights) {
				deactivateCell(noteName);
				setHighlighting(tokenIndex, 0);
			}
			if (oscillator) {
				oscillator.stop();
				delete PLAYBACK_STATE.tones[tokenIndex];
			}
		}, duration));
	}, timeoutStartFromNow);
}

function copy(array) {
	let result = [];
	for (let i=0; i<array.length; i++) {
		result.push(array[i]);
	}
	return result;
}

function stop() {
	PLAYBACK_STATE.playing = false;
	ELEMENTS.playButton.innerText = "‚ñ∂Ô∏è";
	ELEMENTS.playControls.classList.remove("playing");
	for (let i=0; i<PLAYBACK_STATE.timeouts.length; i++) {
		clearTimeout(PLAYBACK_STATE.timeouts[i]);
	}
	for (let t in PLAYBACK_STATE.tones) {
		PLAYBACK_STATE.tones[t].stop();
	}
	PLAYBACK_STATE.timeouts = [];
	PLAYBACK_STATE.tones = {};
	let actives = copy(document.getElementsByClassName("active"));
	for (let j=0; j<actives.length; j++) {
		if (actives[j]) {
			actives[j].classList.remove("active");
			if (actives[j].dataset.activation) {
				actives[j].dataset.activation = 0;
			}
		}
	}
	if (PLAYBACK_STATE.recording) {
		stopRecording();
	}
}

function startRecording() {
	if (!PLAYBACK_STATE.playing) {
		PLAYBACK_STATE.recording = true;
		playSong();
		ELEMENTS.recordButton.style.display = "none";
		ELEMENTS.recordIndicator.style.display = null;
	}
}

function stopRecording() {
	setTimeout(function(){
		AUDIO.recorder.stop();
		PLAYBACK_STATE.recording = false;
		ELEMENTS.recordButton.style.display = null;
		ELEMENTS.recordIndicator.style.display = "none";
	}, FADEOUT_MS);
}

function playSong() {
	if (!PLAYBACK_STATE.playing) {
		ELEMENTS.playButton.innerText = "‚èπ";
		let textarea = document.getElementById("song");
		let songNotation = textarea.value;
		let cursorPosition = textarea.selectionStart;
		let compilation = compileNotation(songNotation);
		let songCompiled = compilation[0];
		let compilationErrors = compilation[1];
		displayErrors(compilationErrors);
		let dissonances = computeDissonances(songCompiled);
		displayDissonances(dissonances);
		play(songCompiled, cursorPosition);
		ELEMENTS.playControls.classList.add("playing");
		PLAYBACK_STATE.playing = true;
	} else {
		stop();
	}
}


// -----
// Link sharing:

const ALPHABET_CODE = {
	"{": 	"101101111",
	"}": 	"10101001000010",
	"A": 	"10111",
	"B": 	"11100",
	"C": 	"11101",
	"D": 	"11010",
	"E": 	"11011",
	"F": 	"11000",
	"G": 	"11001",
	"R": 	"1010101",
	"O": 	"1010110",
	"X": 	"1010111",
	"#": 	"101101010",
	"b": 	"101101011",
	"@": 	"101101100",
	"+": 	"101101101",
	"o": 	"101101000",
	"-": 	"101101001",
	"'": 	"111110",
	",": 	"111111",
	"0": 	"10101001001",
	"1": 	"111100",
	"2": 	"10000",
	"3": 	"10101000",
	"4": 	"10001",
	"5": 	"101010010001111",
	"6": 	"10010",
	"7": 	"10101001000000",
	"8": 	"10011",
	"9": 	"10101001000001",
	".": 	"101100",
	"~": 	"101101110",
	"[": 	"10100010",
	"/": 	"1010000",
	"]": 	"10100011",
	"|": 	"101001",
	"T": 	"10101001011",
	"K": 	"10101001100",
	"(": 	"10101001101",
	")": 	"10101001110",
	"=": 	"10101001111",
	"$": 	"101010010001000",
	"s": 	"101010010001001",
	"t": 	"101010010001100",
	"q": 	"101010010001101",
	"p": 	"101010010001010",
	"u": 	"101010010001011",
	"w": 	"101010010001110",
	" ": 	"0",
	"\n": 	"111101",
	"\t": 	"10101001000011",
	"": 	"10101001010" // reserved for new symbols
};
const ALPHABET_CODE_INV = (function(){
	let result = {};
	for (symbol in ALPHABET_CODE) {
		result[ALPHABET_CODE[symbol]] = symbol;
	}
	return result;
})();

// vibe-coded:
function extractUTF(bits, startIndex) {
    if (startIndex >= bits.length) {
        throw new Error("Start index out of bounds");
    }
    let pos = startIndex;
    // Determine UTF-8 byte length from leading bits (including the terminating 0)
    let leadingOnes = 0;
    while (pos < bits.length && bits[pos] === 1 && leadingOnes < 5) {
        leadingOnes++;
        pos++;
    }

    let bytesNeeded;
    if (leadingOnes === 0) {
        // 0xxxxxxx -> 1 byte (ASCII)
        bytesNeeded = 1;
    } else if (leadingOnes >= 2 && leadingOnes <= 4) {
        // 110xxxxx -> 2, 1110xxxx -> 3, 11110xxx -> 4
        bytesNeeded = leadingOnes;
    } else {
        throw new Error("Invalid UTF-8 starting byte (overlong or invalid prefix)");
    }

    let totalBits = bytesNeeded * 8;
    if (startIndex+totalBits > bits.length) {
        throw new Error("Not enough bits for complete UTF-8 character");
    }

    let charBits = bits.slice(startIndex, startIndex + totalBits);
    let bytes = [];
    for (let i=0; i<bytesNeeded; i++) {
        let b = 0;
        for (let j=0; j<8; j++) {
            b = (b << 1) | charBits[i*8 + j];
        }
        bytes.push(b);
    }

    let character = new TextDecoder("utf-8", { fatal: true }).decode(new Uint8Array(bytes));
    return {
        character: character,
        size: totalBits
    };
}

function bytesToBits(bytes) {
    let bits = [];
    for (let i=0; i<bytes.length; i++) {
    	let byte = bytes[i];
        for (let j=7; j>=0; j--) {
            bits.push((byte >> j) & 1);
        }
    }
    return bits;
}

function bitsToBytes(bits) {
	// bits.length must be a multiple of 8
	let bytes = new Uint8Array(bits.length/8);
	for (let i=0; i<bits.length; i+=8) {
		bytes[i/8] = bits[i]*128 + bits[i+1]*64 + bits[i+2]*32 + bits[i+3]*16 
					+ bits[i+4]*8 + bits[i+5]*4 + bits[i+6]*2 + bits[i+7]*1;
	}
	return bytes;
}

function encode(songText) {
	let bits = [0,0,0];
	let commentingLevel = 0;
	let charArray = Array.from(songText);
	for (let i=0; i<charArray.length; i++) {
		let cha = charArray[i];
		let charEncoding;
		if (commentingLevel) {
			charEncoding = bytesToBits(new TextEncoder().encode(cha));
		} else {
			if (!ALPHABET_CODE[cha]) {
				return false;
			}
			charEncoding = ALPHABET_CODE[cha].split("").map(x => parseInt(x));
		}
		for (let j=0; j<charEncoding.length; j++) {
			bits.push(charEncoding[j]);
		}
		if (cha === "{") {
			commentingLevel++;
		} else if (cha === "}" && commentingLevel) {
			commentingLevel--;
		}
	}
	let paddingCount = (8-((bits.length)%8))%8
	for (let j=0; j<paddingCount; j++) {
		bits.push(1);
	}
	let paddingCountBits = [
		(paddingCount&4) >> 2,
		(paddingCount&2) >> 1,
		(paddingCount&1) >> 0
	];
	// prepend padding count:
	bits[0] = paddingCountBits[0];
	bits[1] = paddingCountBits[1];
	bits[2] = paddingCountBits[2];

	return btoa(Array.from(bitsToBytes(bits), (byte) => String.fromCodePoint(byte)).join(""))
		.replaceAll("+","-")
		.replaceAll("/","_")
		.replaceAll("=","");
}

function decode(encoded) {
	let bits = bytesToBits(
		Array.from(
			atob(encoded.replaceAll("-","+").replaceAll("_","/")),
			c => c.charCodeAt(0)
		)
	);
  	let paddingCount = 4*bits[0] + 2*bits[1] + 1*bits[2];
  	let latest = "";
  	let commentingLevel = 0;
  	let decoded = "";
  	for (let i=3; i<bits.length-paddingCount; i++) {
  		let next;
  		if (commentingLevel) {
  			let extracted = extractUTF(bits, i);
  			next = extracted.character;
  			i += (extracted.size-1);
  		} else {
  			latest += bits[i];
  			next = ALPHABET_CODE_INV[latest];
  			if (next) {
  				latest = "";
  			}
  		}
  		if (next) {
			if (next === "{") {
				commentingLevel++;
			} else if (next === "}" && commentingLevel) {
				commentingLevel--;
			}
			decoded += next;
		}
  	}
  	return decoded;
}

function shareLink() {
	if (!PLAYBACK_STATE.playing) {
		let encoded = encode(ELEMENTS.song.value);
		if (!encoded) {
			alert("Song contains syntax errors; fix these before sharing");
		} else {
			window.location.hash = encoded;
			navigator.clipboard.writeText(window.location.href);
			ELEMENTS.copiedTooltip.classList.add("visible");
			setTimeout(function(){
				ELEMENTS.copiedTooltip.classList.remove("visible");
			}, 1000);
		}
	}
}

function fetch(url, callback) {
	let xhr = new XMLHttpRequest();
	xhr.open("GET", url);
	xhr.onreadystatechange = function () {
		if (xhr.readyState === 4) {
			callback(xhr);
		}
	};
	xhr.send();
}

function fetchGist(gistID, callback) {
	fetch("https://api.github.com/gists/" + gistID, function(xhr) {
		if (xhr.status === 200 || xhr.status === 304) {
			let response = JSON.parse(xhr.responseText);
			// we only care about the first file
			let file = response.files[Object.keys(response.files)[0]];
			if (file && file.content) {
				callback(file.content);
				return;
			} else {
				console.log("github unexpected", xhr);
			}
		} else if (xhr.status === 403 || xhr.status === 404) {
			console.log("github 4xx", xhr);
		} else {
			console.log("github error", xhr);
		}
		callback("{ Error: Could not fetch song from GitHub Gist. Make sure the song is available at https://gist.github.com/" + gistID + " }");
	});
}

function fetchPastebin(pastebinID, callback) {
	fetch("https://pastebin.com/raw/" + pastebinID, function(xhr) {
		if (xhr.status === 200 || xhr.status === 304) {
			let response = xhr.responseText;
			if (response) {
				callback(response);
				return;
			} else {
				console.log("pastebin empty", xhr);
			}
		} else if (xhr.status === 403 || xhr.status === 404) {
			console.log("pastebin 4xx", xhr);
		} else {
			console.log("pastebin error", xhr);
		}
		callback("{ Error: Could not fetch song from Pastebin. Make sure the song is available at https://pastebin.com/" + pastebinID + " }");
	});
}

function displayFetchedContent(optionLabel, key, content) {
	let firstOption = ELEMENTS.selector.getElementsByTagName("option")[0];
	if (firstOption.value === SHARED_SONG_OPTION) {
		firstOption.innerText = optionLabel;
	} else {
		let option = document.createElement("option");
		option.value = SHARED_SONG_OPTION;
		option.innerText = optionLabel;
		ELEMENTS.selector.prepend(option);
	}
	ELEMENTS.selector.selectedIndex = 0;
	ELEMENTS.song.value = content;
	sharedSongContent = content;
	sharedSongKey = key;
	refreshHighlights();
	skipToStart();
}

function refreshHash() {
	let hash = window.location.hash;
	if (hash && hash.length>1) {
		let hashSlice = hash.slice(1);
		let hashSplit = hashSlice.split("/");
		if (hashSplit.length === 1) {
			// content is encoded directly in the hash
			try {
				let decoded = decode(hashSplit[0]);
				displayFetchedContent("(Shared from link)", hashSlice, decoded);
			} catch(e) {
				console.log("Decoding error:", e);
				window.location.hash = "";
				alert("Invalid link!");
			}
		} else if (hashSplit[0].charAt(0) === "g" && hashSplit[1]) {
			// fetch content from GitHub Gist
			let label = "(Shared from GitHub Gist)";
			if (hashSlice === sharedSongKey) {
				displayFetchedContent(label, hashSlice, sharedSongContent);
			} else {
				fetchGist(hashSplit[1], function(content) {
					displayFetchedContent(label, hashSlice, content);
				});
			}
		} else if (hashSplit[0].charAt(0) === "p") {
			// fetch content from Pastebin
			let label = "(Shared from Pastebin)";
			if (hashSlice === sharedSongKey) {
				displayFetchedContent(label, hashSlice, sharedSongContent);
			} else {
				fetchPastebin(hashSplit[1], function(content) {
					displayFetchedContent(label, hashSlice, content);
				});
			}
		} else {
			window.location.hash = "";
			alert("Invalid link!");
		}
	}
}

document.body.onload = refreshHash;
window.onhashchange = refreshHash;

</script>
</body>
</html>
